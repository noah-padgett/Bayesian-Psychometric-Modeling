<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 9 Confirmatory Factor Analysis | Bayesian Psychometric Modeling (2016) by Roy Levy and Robert J. Mislevy</title>
<meta name="author" content="R. Noah Padgett">
<meta name="description" content="The full Bayesian specification of a general CFA model for all associated unknowns is as follows. This includes probability statements, notation, parameters, likelihood, priors, and...">
<meta name="generator" content="bookdown 0.26 with bs4_book()">
<meta property="og:title" content="Chapter 9 Confirmatory Factor Analysis | Bayesian Psychometric Modeling (2016) by Roy Levy and Robert J. Mislevy">
<meta property="og:type" content="book">
<meta property="og:description" content="The full Bayesian specification of a general CFA model for all associated unknowns is as follows. This includes probability statements, notation, parameters, likelihood, priors, and...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 9 Confirmatory Factor Analysis | Bayesian Psychometric Modeling (2016) by Roy Levy and Robert J. Mislevy">
<meta name="twitter:description" content="The full Bayesian specification of a general CFA model for all associated unknowns is as follows. This includes probability statements, notation, parameters, likelihood, priors, and...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Bayesian Psychometric Modeling (2016) by Roy Levy and Robert J. Mislevy</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li class="book-part">Foundations</li>
<li><a class="" href="index.html"><span class="header-section-number">1</span> Index</a></li>
<li><a class="" href="chp2.html"><span class="header-section-number">2</span> Introduction to Bayesian Inference</a></li>
<li><a class="" href="conceptual-issues-in-bayesian-inference.html"><span class="header-section-number">3</span> Conceptual Issues in Bayesian Inference</a></li>
<li><a class="" href="normal-distribution-models.html"><span class="header-section-number">4</span> Normal Distribution Models</a></li>
<li><a class="" href="markov-chain-monte-carlo-estimation.html"><span class="header-section-number">5</span> Markov Chain Monte Carlo Estimation</a></li>
<li><a class="" href="regression.html"><span class="header-section-number">6</span> Regression</a></li>
<li class="book-part">Psychometrics</li>
<li><a class="" href="canonical-bayesian-psychometric-modeling.html"><span class="header-section-number">7</span> Canonical Bayesian Psychometric Modeling</a></li>
<li><a class="" href="classical-test-theory.html"><span class="header-section-number">8</span> Classical Test Theory</a></li>
<li><a class="active" href="confirmatory-factor-analysis.html"><span class="header-section-number">9</span> Confirmatory Factor Analysis</a></li>
<li><a class="" href="model-evaluation.html"><span class="header-section-number">10</span> Model Evaluation</a></li>
<li><a class="" href="item-response-theory.html"><span class="header-section-number">11</span> Item Response Theory</a></li>
<li><a class="" href="missing-data-modeling.html"><span class="header-section-number">12</span> Missing Data Modeling</a></li>
<li><a class="" href="latent-class-analysis.html"><span class="header-section-number">13</span> Latent Class Analysis</a></li>
<li><a class="" href="bayesian-networks.html"><span class="header-section-number">14</span> Bayesian Networks</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/noah-padgett/Bayesian-Psychometric-Modeling">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="confirmatory-factor-analysis" class="section level1" number="9">
<h1>
<span class="header-section-number">9</span> Confirmatory Factor Analysis<a class="anchor" aria-label="anchor" href="#confirmatory-factor-analysis"><i class="fas fa-link"></i></a>
</h1>
<p>The full Bayesian specification of a <em>general</em> CFA model for all associated unknowns is as follows.
This includes probability statements, notation, parameters, likelihood, priors, and hyperparameters.
The observed data is defined as the <span class="math inline">\(n\times J\)</span> matrix <span class="math inline">\(\mathbf{X}\)</span> for the <span class="math inline">\(J\)</span> observed measures.
The CFA model parameters are defined as</p>
<p><span class="math display">\[\begin{align*}
\mathbf{x}_i &amp;= \tau + \Lambda\xi_i + \varepsilon_i\\
\Sigma (\mathbf{x}) &amp;= \Lambda\Phi\Lambda^{\prime} + \Psi
\end{align*}\]</span></p>
<ul>
<li>
<span class="math inline">\(\Xi\)</span> is the <span class="math inline">\(n\times M\)</span> matrix of latent variable scores on the <span class="math inline">\(M\)</span> latent variables for the <span class="math inline">\(n\)</span> respondents/subjects. For an single subject, <span class="math inline">\(\xi_i\)</span> represents the vector of scores on the latent variable(s). Values (location, scale, orientation, etc.) or <span class="math inline">\(\xi_i\)</span> are conditional on (1) <span class="math inline">\(\kappa\)</span>, the <span class="math inline">\(M\times 1\)</span> vector of latent variable means, and (2) <span class="math inline">\(\Phi\)</span>, the <span class="math inline">\(M\times M\)</span> covariance matrix of variable variables;</li>
<li>
<span class="math inline">\(\tau\)</span> is the <span class="math inline">\(J\times 1\)</span> vector of observed variable intercepts which is the expected value for the observed measures when the latent variable(s) are all <span class="math inline">\(0\)</span>;</li>
<li>
<span class="math inline">\(\Lambda\)</span> is the <span class="math inline">\(J\times M\)</span> matrix of factor loadings where the <span class="math inline">\(j\)</span>th row and <span class="math inline">\(m\)</span>th column represents the factor loading of the <span class="math inline">\(j\)</span>th observed variable on the <span class="math inline">\(m\)</span>th latent variable;</li>
<li>
<span class="math inline">\(\delta_i\)</span> is the <span class="math inline">\(J\times 1\)</span> vector of errors, where <span class="math inline">\(E(\delta_i)=\mathbf{0}\)</span> with <span class="math inline">\(\mathrm{var}(\delta_i)=\Psi\)</span> which is the <span class="math inline">\(J\times J\)</span> error covariance matrix.</li>
</ul>
<p><span class="math display">\[\begin{align*}
p(\Xi, \kappa, \Phi, \tau, \Lambda, \Psi\mid \mathbf{X}) &amp;\propto p(\mathbf{X}\mid\Xi, \kappa, \Phi, \tau, \Lambda, \Psi)p(\Xi, \kappa, \Phi, \tau, \Lambda, \Psi)\\
  &amp;= p(\mathbf{X}\mid\Xi, \kappa, \Phi, \tau, \Lambda, \Psi) p(\Xi\mid\kappa, \Phi) p(\kappa) p(\Phi) p(\tau) p(\Lambda) p(\Psi)\\
  &amp;= \prod_{i=1}^{n}\prod_{j=1}^J\prod_{m=1}^M p(x_{ij}\mid\xi_i, \tau_j,\lambda_j, \psi_{jj}) p(\xi_i\mid\kappa, \Phi) p(\kappa_m) p(\Phi) p(\tau_j) p(\lambda_j) p(\psi_{jj})
\end{align*}\]</span>
where</p>
<p><span class="math display">\[\begin{align*}
x_{ij}\mid\xi_i, \tau_j,\lambda_j, \psi_{jj} &amp;\sim \mathrm{Normal}(\tau_j+\xi_i\lambda^{\prime}_j, \psi_{jj}),\ \mathrm{for}\ i=1, \cdots, n,\ j = 1, \cdots, J;\\
\xi_i\mid\kappa, \Phi &amp;\sim \mathrm{Normal}(\kappa, \Phi),\ \mathrm{for}\ i=1, \cdots, n;\\
\kappa_m &amp;\sim \mathrm{Normal}(\mu_{\kappa},\sigma^2_{\kappa}),\ \mathrm{for}\ m = 1, \cdots, M;\\
\Phi &amp;\sim \mathrm{Inverse-Wishart}(\Phi_0, d);\\
\tau_j &amp;\sim \mathrm{Normal}(\mu_{\tau},\sigma^2_{\tau}),\ \mathrm{for}\ j = 1, \cdots, J;\\
\lambda_{j,m} &amp;\sim \mathrm{Normal}(\mu_{\lambda}, \sigma^2_{\lambda}),\ \mathrm{for}\ j = 1, \cdots, J,\ m = 1, \cdots, M;\\
\psi_{jj} &amp;\sim \mathrm{Inverse-Gamma}(\nu_{\psi}/2, \nu_{\psi}\psi_0/2),\ \mathrm{for}\ j=1, \cdots, J.
\end{align*}\]</span>
With the hyperparameters that are supplied by the analyst being defined as</p>
<ul>
<li>
<span class="math inline">\(\mu_{\kappa}\)</span> is the prior mean for the latent variable,</li>
<li>
<span class="math inline">\(\sigma^2_{\kappa}\)</span> is the prior variance for the latent variable,</li>
<li>
<span class="math inline">\(\Phi_0\)</span> is the prior expectation for the covariance matrix among latent variables,</li>
<li>
<span class="math inline">\(d\)</span> represents a dispersion parameter reflecting the magnitude of our beliefs about <span class="math inline">\(\Phi_0\)</span>,</li>
<li>
<span class="math inline">\(\mu_{\tau}\)</span> is the prior mean for the intercepts which reflects our knowledge about the location of the observed variables,</li>
<li>
<span class="math inline">\(\sigma^2_{\tau}\)</span> is a measure of how much weight we want to give to the prior mean,</li>
<li>
<span class="math inline">\(\mu_{\lambda}\)</span> is the prior mean for the factor loadings which can vary over items and latent variables,</li>
<li>
<span class="math inline">\(\sigma^2_{\lambda}\)</span> is the measure of dispersion for the the factor loadings, where lower variances indicate a stronger belief about the values for the loadings,</li>
<li>
<span class="math inline">\(\nu_{\psi}\)</span> is the measure of location for the gamma prior indicating our expectation for the magnitude of the error variance,</li>
<li>
<span class="math inline">\(\psi_0\)</span> is our uncertainty with respect to the location we selected for the variance, and</li>
<li>Alternatively, we could place a prior on <span class="math inline">\(\Psi\)</span> instead of the individual residual variances. This would mean we would be placing a prior on the error-covariance matrix similar to how we specified a prior for latent variance covariance matrix.</li>
</ul>
<div id="single-latent-variable-model" class="section level2" number="9.1">
<h2>
<span class="header-section-number">9.1</span> Single Latent Variable Model<a class="anchor" aria-label="anchor" href="#single-latent-variable-model"><i class="fas fa-link"></i></a>
</h2>
<p>Here we consider the model in section 9.3 which is a CFA model with 1 latent variable and 5 observed indicators.
The graphical representation of these factor models get pretty complex pretty quickly, but for this example I have reproduced a version of Figure 9.3b, shown below.</p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:chp9-dag-1"></span>
<img src="dag/chp9-cfa1.png" alt="DAG for CFA model with 1 latent variable" width="75%" height="90%"><p class="caption">
Figure 9.1: DAG for CFA model with 1 latent variable
</p>
</div>
<p>However, as the authors noted, the path diagram tradition of conveying models is also very useful in discussing and describing the model, which I give next.</p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:chp9-pathdiag-1"></span>
<img src="path-diagram/chp9-cfa1.png" alt="Path diagram for CFA model with 1 latent variable" width="90%" height="90%"><p class="caption">
Figure 9.2: Path diagram for CFA model with 1 latent variable
</p>
</div>
<p>For completeness, I have included the model specification diagram that more concretely connects the DAG and path diagram to the assumed distributions and priors.</p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:chp9-spec-1"></span>
<img src="model-spec/chp9-cfa1.png" alt="Model specification diagram for the CFA model with 1 latent factor" width="90%" height="90%"><p class="caption">
Figure 9.3: Model specification diagram for the CFA model with 1 latent factor
</p>
</div>
</div>
<div id="jags---single-latent-variable" class="section level2" number="9.2">
<h2>
<span class="header-section-number">9.2</span> JAGS - Single Latent Variable<a class="anchor" aria-label="anchor" href="#jags---single-latent-variable"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb156"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># model code</span>
<span class="va">jags.model.cfa1</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span>

  <span class="co">########################################</span>
  <span class="co"># Specify the factor analysis measurement model for the observables</span>
  <span class="co">##############################################</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span><span class="op">{</span>
    <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">J</span><span class="op">)</span><span class="op">{</span>
      <span class="va">mu</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">tau</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">+</span> <span class="va">ksi</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">*</span><span class="va">lambda</span><span class="op">[</span><span class="va">j</span><span class="op">]</span>      <span class="co"># model implied expectation for each observable</span>
      <span class="va">x</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">mu</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span><span class="op">]</span>, <span class="va">inv.psi</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span>    <span class="co"># distribution for each observable</span>
    <span class="op">}</span>
  <span class="op">}</span>
  
  
  <span class="co">##################################</span>
  <span class="co"># Specify the (prior) distribution for the latent variables</span>
  <span class="co">####################################</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span><span class="op">{</span>
    <span class="va">ksi</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">kappa</span>, <span class="va">inv.phi</span><span class="op">)</span>  <span class="co"># distribution for the latent variables</span>
  <span class="op">}</span>
  
  
  <span class="co">######################################</span>
  <span class="co"># Specify the prior distribution for the parameters that govern the latent variables</span>
  <span class="co">###################################</span>
  <span class="va">kappa</span> <span class="op">&lt;-</span> <span class="fl">0</span>              <span class="co"># Mean of factor 1</span>
  <span class="va">inv.phi</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html">dgamma</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span> <span class="co"># Precision of factor 1</span>
  <span class="va">phi</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="va">inv.phi</span>        <span class="co"># Variance of factor 1</span>
  
  
  <span class="co">########################################</span>
  <span class="co"># Specify the prior distribution for the measurement model parameters</span>
  <span class="co">########################################</span>
  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">J</span><span class="op">)</span><span class="op">{</span>
    <span class="va">tau</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">.1</span><span class="op">)</span>        <span class="co"># Intercepts for observables</span>
    <span class="va">inv.psi</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html">dgamma</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span> <span class="co"># Precisions for observables</span>
    <span class="va">psi</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="va">inv.psi</span><span class="op">[</span><span class="va">j</span><span class="op">]</span>   <span class="co"># Variances for observables</span>
  <span class="op">}</span>
  
  <span class="va">lambda</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1.0</span>              <span class="co"># loading fixed to 1.0 </span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="va">J</span><span class="op">)</span><span class="op">{</span>
    <span class="va">lambda</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">.1</span><span class="op">)</span>    <span class="co"># prior distribution for the remaining loadings</span>
  <span class="op">}</span>
<span class="op">}</span>
<span class="co"># data must be in a list</span>
<span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span><span class="op">(</span><span class="st">"code/CFA-One-Latent-Variable/Data/IIS.dat"</span>, header<span class="op">=</span><span class="cn">T</span><span class="op">)</span>

<span class="va">mydata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  n <span class="op">=</span> <span class="fl">500</span>, J <span class="op">=</span> <span class="fl">5</span>,
  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span>
<span class="op">)</span>


<span class="co"># initial values</span>
<span class="va">start_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"tau"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.1</span>, <span class="fl">.1</span>, <span class="fl">.1</span>, <span class="fl">.1</span>, <span class="fl">.1</span><span class="op">)</span>,
       <span class="st">"lambda"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>,
       <span class="st">"inv.phi"</span><span class="op">=</span><span class="fl">1</span>,
       <span class="st">"inv.psi"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"tau"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">3</span>, <span class="fl">3</span>, <span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span>,
       <span class="st">"lambda"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">3</span>, <span class="fl">3</span>, <span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span>,
       <span class="st">"inv.phi"</span><span class="op">=</span><span class="fl">2</span>,
       <span class="st">"inv.psi"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"tau"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">5</span>, <span class="fl">5</span>, <span class="fl">5</span>, <span class="fl">5</span><span class="op">)</span>,
       <span class="st">"lambda"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">6</span>, <span class="fl">6</span>, <span class="fl">6</span>, <span class="fl">6</span><span class="op">)</span>,
       <span class="st">"inv.phi"</span><span class="op">=</span><span class="fl">.5</span>,
       <span class="st">"inv.psi"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.5</span>, <span class="fl">.5</span>, <span class="fl">.5</span>, <span class="fl">.5</span>, <span class="fl">.5</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># vector of all parameters to save</span>
<span class="co"># exclude fixed lambda since it throws an error in</span>
<span class="co"># in the GRB plot</span>
<span class="va">param_save</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"tau"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"lambda["</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">5</span>,<span class="st">"]"</span><span class="op">)</span>, <span class="st">"phi"</span>, <span class="st">"psi"</span><span class="op">)</span>

<span class="co"># fit model</span>
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">jags</span><span class="op">(</span>
  model.file<span class="op">=</span><span class="va">jags.model.cfa1</span>,
  data<span class="op">=</span><span class="va">mydata</span>,
  inits<span class="op">=</span><span class="va">start_values</span>,
  parameters.to.save <span class="op">=</span> <span class="va">param_save</span>,
  n.iter<span class="op">=</span><span class="fl">5000</span>,
  n.burnin <span class="op">=</span> <span class="fl">2500</span>,
  n.chains <span class="op">=</span> <span class="fl">3</span>,
  n.thin<span class="op">=</span><span class="fl">1</span>,
  progress.bar <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></code></pre></div>
<pre><code>## module glm loaded</code></pre>
<pre><code>## Compiling model graph
##    Resolving undeclared variables
##    Allocating nodes
## Graph information:
##    Observed stochastic nodes: 2500
##    Unobserved stochastic nodes: 515
##    Total graph size: 8029
## 
## Initializing model</code></pre>
<div class="sourceCode" id="cb159"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></code></pre></div>
<pre><code>## Inference for Bugs model at "C:/Users/noahp/AppData/Local/Temp/RtmpaGlb2m/model324459da2493.txt", fit using jags,
##  3 chains, each with 5000 iterations (first 2500 discarded)
##  n.sims = 7500 iterations saved
##            mu.vect sd.vect     2.5%      25%      50%      75%    97.5%  Rhat n.eff
## lambda[2]    0.730   0.045    0.646    0.699    0.729    0.760    0.820 1.001  7500
## lambda[3]    0.421   0.037    0.351    0.396    0.420    0.445    0.495 1.001  7500
## lambda[4]    1.053   0.066    0.930    1.008    1.051    1.095    1.187 1.001  6000
## lambda[5]    0.987   0.059    0.875    0.947    0.985    1.026    1.107 1.002  2400
## phi          0.434   0.043    0.354    0.404    0.432    0.463    0.524 1.002  2600
## psi[1]       0.373   0.028    0.320    0.353    0.372    0.391    0.433 1.001  7500
## psi[2]       0.183   0.014    0.157    0.173    0.182    0.192    0.212 1.003  1100
## psi[3]       0.180   0.012    0.157    0.171    0.179    0.187    0.205 1.002  1400
## psi[4]       0.378   0.030    0.323    0.357    0.376    0.398    0.440 1.001  3800
## psi[5]       0.265   0.022    0.225    0.250    0.264    0.279    0.309 1.002  2500
## tau[1]       3.333   0.040    3.255    3.305    3.333    3.359    3.412 1.001  7500
## tau[2]       3.898   0.029    3.841    3.879    3.898    3.917    3.955 1.001  7500
## tau[3]       4.596   0.023    4.553    4.581    4.596    4.611    4.641 1.002  2300
## tau[4]       3.033   0.042    2.953    3.005    3.033    3.062    3.116 1.001  4400
## tau[5]       3.712   0.037    3.639    3.688    3.712    3.737    3.784 1.001  7500
## deviance  3379.989  42.451 3297.778 3351.818 3379.183 3408.556 3465.562 1.001  7500
## 
## For each parameter, n.eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor (at convergence, Rhat=1).
## 
## DIC info (using the rule, pD = var(deviance)/2)
## pD = 901.2 and DIC = 4281.2
## DIC is an estimate of expected predictive error (lower deviance is better).</code></pre>
<div class="sourceCode" id="cb161"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># extract posteriors for all chains</span>
<span class="va">jags.mcmc</span> <span class="op">&lt;-</span> <span class="fu">as.mcmc</span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>

<span class="fu">R2jags</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/R2jags/man/traceplot.html">traceplot</a></span><span class="op">(</span><span class="va">jags.mcmc</span><span class="op">)</span></code></pre></div>
<p><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-1-1.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-1-2.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-1-3.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-1-4.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-1-5.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-1-6.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-1-7.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-1-8.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-1-9.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-1-10.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-1-11.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-1-12.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-1-13.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-1-14.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-1-15.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-1-16.png" width="90%" height="90%"></p>
<div class="sourceCode" id="cb162"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># gelman-rubin-brook</span>
<span class="fu">gelman.plot</span><span class="op">(</span><span class="va">jags.mcmc</span><span class="op">)</span></code></pre></div>
<p><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-1-17.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-1-18.png" width="90%" height="90%"></p>
<div class="sourceCode" id="cb163"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># convert to single data.frame for density plot</span>
<span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">jags.mcmc</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
<span class="va">plot.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">jags.mcmc</span>, chains<span class="op">=</span><span class="cn">T</span>, iters <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">plot.data</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"chain"</span>, <span class="st">"iter"</span>, <span class="va">a</span><span class="op">)</span>


<span class="va">plot_title</span> <span class="op">&lt;-</span> <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Posterior distributions"</span>,
                      <span class="st">"with medians and 80% intervals"</span><span class="op">)</span>
<span class="fu">mcmc_areas</span><span class="op">(</span>
  <span class="va">plot.data</span>,
  pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"tau["</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="st">"]"</span><span class="op">)</span><span class="op">)</span>,
  prob <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span>
  <span class="va">plot_title</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-1-19.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb164"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">mcmc_areas</span><span class="op">(</span>
  <span class="va">plot.data</span>,
  pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"lambda["</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">5</span>, <span class="st">"]"</span><span class="op">)</span><span class="op">)</span>,
  prob <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span>
  <span class="va">plot_title</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-1-20.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb165"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">mcmc_areas</span><span class="op">(</span>
  <span class="va">plot.data</span>,
  pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"psi["</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="st">"]"</span><span class="op">)</span>, <span class="st">"phi"</span><span class="op">)</span>,
  prob <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span>
  <span class="va">plot_title</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-1-21.png" width="90%" height="90%"></div>
</div>
<div id="stan---single-latent-variable" class="section level2" number="9.3">
<h2>
<span class="header-section-number">9.3</span> Stan - Single Latent Variable<a class="anchor" aria-label="anchor" href="#stan---single-latent-variable"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb166"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model_cfa1</span> <span class="op">&lt;-</span> <span class="st">'
data {
  int  N;
  int  J;
  matrix[N, J] X;
}

parameters {
  real ksi[N]; //latent variable values
  real tau[J]; //intercepts
  real load[J-1]; //factor loadings
  real&lt;lower=0&gt; psi[J]; //residual variance
  //real kappa; // factor means
  real&lt;lower=0&gt; phi; // factor variances
}

transformed parameters {
  real lambda[J];
  lambda[1] = 1;
  lambda[2:J] = load;
}

model {
  real kappa;
  kappa = 0;
  // likelihood for data
  for(i in 1:N){
    for(j in 1:J){
      X[i, j] ~ normal(tau[j] + ksi[i]*lambda[j], psi[j]);
    }
  }
  // prior for latent variable parameters
  ksi ~ normal(kappa, phi);
  
  phi ~ inv_gamma(5, 10);
  // prior for measurement model parameters
  tau ~ normal(3, 10);
  psi ~ inv_gamma(5, 10);

  for(j in 1:(J-1)){
    load[j] ~ normal(1, 10);
  }
  
}

'</span>
<span class="co"># data must be in a list</span>
<span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span><span class="op">(</span><span class="st">"code/CFA-One-Latent-Variable/Data/IIS.dat"</span>, header<span class="op">=</span><span class="cn">T</span><span class="op">)</span>

<span class="va">mydata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  N <span class="op">=</span> <span class="fl">500</span>, J <span class="op">=</span> <span class="fl">5</span>,
  X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># initial values</span>
<span class="va">start_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>tau <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.1</span>,<span class="fl">.1</span>,<span class="fl">.1</span>,<span class="fl">.1</span>,<span class="fl">.1</span><span class="op">)</span>, lambda<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, phi <span class="op">=</span> <span class="fl">1</span>, psi<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>tau <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">3</span><span class="op">)</span>, lambda<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">3</span>, <span class="fl">3</span>, <span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span>, phi <span class="op">=</span> <span class="fl">2</span>, psi<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.5</span>, <span class="fl">.5</span>, <span class="fl">.5</span>, <span class="fl">.5</span>, <span class="fl">.5</span><span class="op">)</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>tau <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">5</span>, <span class="fl">5</span>, <span class="fl">5</span>, <span class="fl">5</span><span class="op">)</span>, lambda<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">6</span>, <span class="fl">6</span>, <span class="fl">6</span>, <span class="fl">6</span>, <span class="fl">6</span><span class="op">)</span>, phi <span class="op">=</span> <span class="fl">2</span>, psi<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># Next, need to fit the model</span>
<span class="co">#   I have explicitly outlined some common parameters</span>
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">stan</span><span class="op">(</span>
  model_code <span class="op">=</span> <span class="va">model_cfa1</span>, <span class="co"># model code to be compiled</span>
  data <span class="op">=</span> <span class="va">mydata</span>,          <span class="co"># my data</span>
  init <span class="op">=</span> <span class="va">start_values</span>,    <span class="co"># starting values</span>
  chains <span class="op">=</span> <span class="fl">3</span>,             <span class="co"># number of Markov chains</span>
  warmup <span class="op">=</span> <span class="fl">1000</span>,          <span class="co"># number of warm up iterations per chain</span>
  iter <span class="op">=</span> <span class="fl">5000</span>,            <span class="co"># total number of iterations per chain</span>
  cores <span class="op">=</span> <span class="fl">1</span>,              <span class="co"># number of cores (could use one per chain)</span>
  refresh <span class="op">=</span> <span class="fl">0</span>             <span class="co"># no progress shown</span>
<span class="op">)</span>

<span class="co"># first get a basic breakdown of the posteriors</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">fit</span>,pars <span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lambda"</span>, <span class="st">"tau"</span>, <span class="st">"psi"</span>, <span class="st">"phi"</span>, <span class="st">"ksi[1]"</span>, <span class="st">"ksi[8]"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## Inference for Stan model: anon_model.
## 3 chains, each with iter=5000; warmup=1000; thin=1; 
## post-warmup draws per chain=4000, total post-warmup draws=12000.
## 
##            mean se_mean   sd  2.5%   25%   50%   75% 97.5% n_eff Rhat
## lambda[1]  1.00     NaN 0.00  1.00  1.00  1.00  1.00  1.00   NaN  NaN
## lambda[2]  0.81       0 0.05  0.72  0.78  0.81  0.85  0.92  1491    1
## lambda[3]  0.47       0 0.04  0.40  0.45  0.47  0.50  0.55  2377    1
## lambda[4]  1.10       0 0.07  0.97  1.05  1.10  1.15  1.26  1682    1
## lambda[5]  1.06       0 0.07  0.93  1.01  1.06  1.10  1.20  1491    1
## tau[1]     3.33       0 0.04  3.26  3.31  3.33  3.36  3.41  2409    1
## tau[2]     3.90       0 0.03  3.84  3.88  3.90  3.92  3.95  2080    1
## tau[3]     4.60       0 0.02  4.55  4.58  4.60  4.61  4.64  3140    1
## tau[4]     3.03       0 0.04  2.96  3.01  3.03  3.06  3.11  2329    1
## tau[5]     3.71       0 0.04  3.64  3.69  3.71  3.74  3.78  2098    1
## psi[1]     0.60       0 0.02  0.55  0.58  0.60  0.61  0.64  8087    1
## psi[2]     0.36       0 0.02  0.33  0.35  0.36  0.37  0.40  4521    1
## psi[3]     0.37       0 0.01  0.35  0.37  0.37  0.38  0.40  9691    1
## psi[4]     0.60       0 0.02  0.56  0.59  0.60  0.62  0.65  7454    1
## psi[5]     0.48       0 0.02  0.44  0.47  0.48  0.50  0.52  5708    1
## phi        0.60       0 0.03  0.54  0.58  0.60  0.62  0.67  1459    1
## ksi[1]    -0.23       0 0.22 -0.67 -0.38 -0.23 -0.08  0.21 18018    1
## ksi[8]     0.85       0 0.23  0.41  0.69  0.84  0.99  1.30 11586    1
## 
## Samples were drawn using NUTS(diag_e) at Mon Jun 20 03:38:56 2022.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
<div class="sourceCode" id="cb168"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># plot the posterior in a</span>
<span class="co">#  95% probability interval</span>
<span class="co">#  and 80% to contrast the dispersion</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fit</span>,pars <span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lambda"</span>, <span class="st">"tau"</span>, <span class="st">"psi"</span>, <span class="st">"phi"</span>, <span class="st">"ksi[1]"</span>, <span class="st">"ksi[8]"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## ci_level: 0.8 (80% intervals)</code></pre>
<pre><code>## outer_level: 0.95 (95% intervals)</code></pre>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-stan-1-1.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb171"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># traceplots</span>
<span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-traceplot.html">traceplot</a></span><span class="op">(</span><span class="va">fit</span>,pars <span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lambda"</span>, <span class="st">"tau"</span>, <span class="st">"psi"</span>, <span class="st">"phi"</span>, <span class="st">"ksi[1]"</span>, <span class="st">"ksi[8]"</span><span class="op">)</span>, inc_warmup <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-stan-1-2.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb172"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Gelman-Rubin-Brooks Convergence Criterion</span>
<span class="fu">ggs_grb</span><span class="op">(</span><span class="fu">ggs</span><span class="op">(</span><span class="va">fit</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lambda"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
   <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## Warning: Removed 50 row(s) containing missing values (geom_path).</code></pre>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-stan-1-3.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb174"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggs_grb</span><span class="op">(</span><span class="fu">ggs</span><span class="op">(</span><span class="va">fit</span>, family <span class="op">=</span> <span class="st">"tau"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
   <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-stan-1-4.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb175"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggs_grb</span><span class="op">(</span><span class="fu">ggs</span><span class="op">(</span><span class="va">fit</span>, family <span class="op">=</span> <span class="st">"psi"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
   <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-stan-1-5.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb176"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggs_grb</span><span class="op">(</span><span class="fu">ggs</span><span class="op">(</span><span class="va">fit</span>, family <span class="op">=</span> <span class="st">"phi"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
   <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-stan-1-6.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb177"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># autocorrelation</span>
<span class="fu">ggs_autocorrelation</span><span class="op">(</span><span class="fu">ggs</span><span class="op">(</span><span class="va">fit</span>, family<span class="op">=</span><span class="st">"lambda"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
   <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## Warning in cor(X, use = "pairwise.complete.obs"): the standard deviation is zero</code></pre>
<pre><code>## Warning in cor(X, use = "pairwise.complete.obs"): the standard deviation is zero

## Warning in cor(X, use = "pairwise.complete.obs"): the standard deviation is zero</code></pre>
<pre><code>## Warning: Removed 150 rows containing missing values (geom_bar).</code></pre>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-stan-1-7.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb181"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggs_autocorrelation</span><span class="op">(</span><span class="fu">ggs</span><span class="op">(</span><span class="va">fit</span>, family<span class="op">=</span><span class="st">"tau"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
   <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-stan-1-8.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb182"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggs_autocorrelation</span><span class="op">(</span><span class="fu">ggs</span><span class="op">(</span><span class="va">fit</span>, family<span class="op">=</span><span class="st">"psi"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
   <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-stan-1-9.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb183"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggs_autocorrelation</span><span class="op">(</span><span class="fu">ggs</span><span class="op">(</span><span class="va">fit</span>, family<span class="op">=</span><span class="st">"phi"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
   <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-stan-1-10.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb184"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># plot the posterior density</span>
<span class="va">plot.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>

<span class="va">plot_title</span> <span class="op">&lt;-</span> <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Posterior distributions"</span>,
                      <span class="st">"with medians and 80% intervals"</span><span class="op">)</span>
<span class="fu">mcmc_areas</span><span class="op">(</span>
  <span class="va">plot.data</span>,
  pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"lambda["</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="st">"]"</span><span class="op">)</span>,
  prob <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span>
  <span class="va">plot_title</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-stan-1-11.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb185"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">mcmc_areas</span><span class="op">(</span>
  <span class="va">plot.data</span>,
  pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"tau["</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="st">"]"</span><span class="op">)</span>,
  prob <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span>
  <span class="va">plot_title</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-stan-1-12.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb186"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">mcmc_areas</span><span class="op">(</span>
  <span class="va">plot.data</span>,
  pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"psi["</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="st">"]"</span><span class="op">)</span>,
           <span class="st">"phi"</span><span class="op">)</span>,
  prob <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span>
  <span class="va">plot_title</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-stan-1-13.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb187"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># I prefer a posterior plot that includes prior and MLE</span>
<span class="co"># Expanded Posterior Plot</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"x"</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>
<span class="va">lav.mod</span> <span class="op">&lt;-</span> <span class="st">'
  xi =~ 1*x1 + x2 + x3 + x4 + x5
  xi ~~ xi
  x1 ~ 1
  x2 ~ 1
  x3 ~ 1
  x4 ~ 1
  x5 ~ 1
'</span>
<span class="va">lav.fit</span> <span class="op">&lt;-</span> <span class="fu">lavaan</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lavaan/man/cfa.html">cfa</a></span><span class="op">(</span><span class="va">lav.mod</span>, data<span class="op">=</span><span class="va">dat</span><span class="op">)</span>

<span class="va">MLE</span> <span class="op">&lt;-</span> <span class="fu">lavaan</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lavaan/man/parameterEstimates.html">parameterEstimates</a></span><span class="op">(</span><span class="va">lav.fit</span><span class="op">)</span>

<span class="va">prior_tau</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">3</span>, <span class="fl">10</span><span class="op">)</span><span class="op">}</span>
<span class="va">x.tau</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span>, <span class="fl">0.01</span><span class="op">)</span>
<span class="va">prior.tau</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>tau<span class="op">=</span><span class="va">x.tau</span>, dens.mtau <span class="op">=</span> <span class="fu">prior_tau</span><span class="op">(</span><span class="va">x.tau</span><span class="op">)</span><span class="op">)</span>

<span class="va">prior_lambda</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span><span class="op">}</span>
<span class="va">x.lambda</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">0.01</span><span class="op">)</span>
<span class="va">prior.lambda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>lambda<span class="op">=</span><span class="va">x.lambda</span>, dens.lambda <span class="op">=</span> <span class="fu">prior_lambda</span><span class="op">(</span><span class="va">x.lambda</span><span class="op">)</span><span class="op">)</span>

<span class="va">prior_sig</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="fu">dinvgamma</span><span class="op">(</span><span class="va">x</span>, <span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span><span class="op">}</span>
<span class="va">x.sig</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">.01</span>, <span class="fl">1</span>, <span class="fl">0.01</span><span class="op">)</span>
<span class="va">prior.sig</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>sig<span class="op">=</span><span class="va">x.sig</span>, dens.sig <span class="op">=</span> <span class="fu">prior_sig</span><span class="op">(</span><span class="va">x.sig</span><span class="op">)</span><span class="op">)</span>

<span class="va">prior_sige</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="fu">dinvgamma</span><span class="op">(</span><span class="va">x</span>, <span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span><span class="op">}</span>
<span class="va">x.sige</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">.1</span>, <span class="fl">10</span>, <span class="fl">0.1</span><span class="op">)</span>
<span class="va">prior.sige</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>sige<span class="op">=</span><span class="va">x.sige</span>, dens.sige <span class="op">=</span> <span class="fu">prior_sige</span><span class="op">(</span><span class="va">x.sige</span><span class="op">)</span><span class="op">)</span>

<span class="va">prior_ksi</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span>
  <span class="va">mu</span> <span class="op">&lt;-</span> <span class="fl">0</span>
  <span class="va">sig</span> <span class="op">&lt;-</span> <span class="fu">rinvgamma</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">mu</span>, <span class="va">sig</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">x.ksi</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">5</span>, <span class="fl">5</span>, <span class="fl">0.01</span><span class="op">)</span>
<span class="va">prior.ksi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>ksi<span class="op">=</span><span class="fu">prior_ksi</span><span class="op">(</span><span class="fl">10000</span><span class="op">)</span><span class="op">)</span>

<span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Posterior"</span><span class="op">=</span><span class="st">"#0072B2"</span>, <span class="st">"Prior"</span><span class="op">=</span><span class="st">"#E69F00"</span>, <span class="st">"MLE"</span><span class="op">=</span> <span class="st">"black"</span><span class="op">)</span><span class="co">#"#56B4E9", "#E69F00" "#CC79A7"</span>

<span class="co"># get stan samples</span>
<span class="va">plot.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">plot.data</span><span class="op">)</span>

<span class="co"># make plotting pieces</span>
<span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">plot.data</span>,
               <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">`lambda[1]`</span>, color<span class="op">=</span><span class="st">"Posterior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span>data<span class="op">=</span><span class="va">prior.lambda</span>,
            <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">lambda</span>, y<span class="op">=</span><span class="va">dens.lambda</span>, color<span class="op">=</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept<span class="op">=</span><span class="va">MLE</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">4</span><span class="op">]</span>, color<span class="op">=</span><span class="st">"MLE"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">cols</span>, name<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">lims</span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.25</span>, <span class="fl">1.5</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">plot.data</span>,
               <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">`lambda[2]`</span>, color<span class="op">=</span><span class="st">"Posterior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span>data<span class="op">=</span><span class="va">prior.lambda</span>,
            <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">lambda</span>, y<span class="op">=</span><span class="va">dens.lambda</span>, color<span class="op">=</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept<span class="op">=</span><span class="va">MLE</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">4</span><span class="op">]</span>, color<span class="op">=</span><span class="st">"MLE"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">cols</span>, name<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">lims</span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.25</span>, <span class="fl">1.5</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">plot.data</span>,
               <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">`lambda[3]`</span>, color<span class="op">=</span><span class="st">"Posterior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span>data<span class="op">=</span><span class="va">prior.lambda</span>,
            <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">lambda</span>, y<span class="op">=</span><span class="va">dens.lambda</span>, color<span class="op">=</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept<span class="op">=</span><span class="va">MLE</span><span class="op">[</span><span class="fl">3</span>, <span class="fl">4</span><span class="op">]</span>, color<span class="op">=</span><span class="st">"MLE"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">cols</span>, name<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">lims</span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.25</span>, <span class="fl">1.5</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">p4</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">plot.data</span>,
               <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">`lambda[4]`</span>, color<span class="op">=</span><span class="st">"Posterior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span>data<span class="op">=</span><span class="va">prior.lambda</span>,
            <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">lambda</span>, y<span class="op">=</span><span class="va">dens.lambda</span>, color<span class="op">=</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept<span class="op">=</span><span class="va">MLE</span><span class="op">[</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">]</span>, color<span class="op">=</span><span class="st">"MLE"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">cols</span>, name<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">lims</span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.25</span>, <span class="fl">1.5</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">p5</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">plot.data</span>,
               <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">`lambda[5]`</span>, color<span class="op">=</span><span class="st">"Posterior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span>data<span class="op">=</span><span class="va">prior.lambda</span>,
            <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">lambda</span>, y<span class="op">=</span><span class="va">dens.lambda</span>, color<span class="op">=</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept<span class="op">=</span><span class="va">MLE</span><span class="op">[</span><span class="fl">5</span>, <span class="fl">4</span><span class="op">]</span>, color<span class="op">=</span><span class="st">"MLE"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">cols</span>, name<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">lims</span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.25</span>, <span class="fl">1.5</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span> <span class="op">+</span> <span class="va">p3</span> <span class="op">+</span> <span class="va">p4</span> <span class="op">+</span> <span class="va">p5</span> <span class="op">+</span> <span class="fu">plot_layout</span><span class="op">(</span>guides<span class="op">=</span><span class="st">"collect"</span><span class="op">)</span></code></pre></div>
<pre><code>## Warning: Removed 75 row(s) containing missing values (geom_path).</code></pre>
<pre><code>## Warning: Removed 75 row(s) containing missing values (geom_path).
## Removed 75 row(s) containing missing values (geom_path).
## Removed 75 row(s) containing missing values (geom_path).
## Removed 75 row(s) containing missing values (geom_path).</code></pre>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-stan-1-14.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb190"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># phi</span>
<span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">plot.data</span>,
               <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">`phi`</span>, color<span class="op">=</span><span class="st">"Posterior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span>data<span class="op">=</span><span class="va">prior.sig</span>,
            <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">sig</span>, y<span class="op">=</span><span class="va">dens.sig</span>, color<span class="op">=</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">MLE</span><span class="op">[</span><span class="fl">6</span>,<span class="fl">4</span><span class="op">]</span><span class="op">)</span>, color<span class="op">=</span><span class="st">"MLE"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">cols</span>, name<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="co"># psi</span>
<span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">plot.data</span>,
               <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">`psi[1]`</span>, color<span class="op">=</span><span class="st">"Posterior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span>data<span class="op">=</span><span class="va">prior.sig</span>,
            <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">sig</span>, y<span class="op">=</span><span class="va">dens.sig</span>, color<span class="op">=</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">MLE</span><span class="op">[</span><span class="fl">12</span>,<span class="fl">4</span><span class="op">]</span><span class="op">)</span>, color<span class="op">=</span><span class="st">"MLE"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">cols</span>, name<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">plot.data</span>,
               <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">`psi[2]`</span>, color<span class="op">=</span><span class="st">"Posterior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span>data<span class="op">=</span><span class="va">prior.sig</span>,
            <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">sig</span>, y<span class="op">=</span><span class="va">dens.sig</span>, color<span class="op">=</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">MLE</span><span class="op">[</span><span class="fl">13</span>,<span class="fl">4</span><span class="op">]</span><span class="op">)</span>, color<span class="op">=</span><span class="st">"MLE"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">cols</span>, name<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">p4</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">plot.data</span>,
               <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">`psi[3]`</span>, color<span class="op">=</span><span class="st">"Posterior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span>data<span class="op">=</span><span class="va">prior.sig</span>,
            <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">sig</span>, y<span class="op">=</span><span class="va">dens.sig</span>, color<span class="op">=</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">MLE</span><span class="op">[</span><span class="fl">14</span>,<span class="fl">4</span><span class="op">]</span><span class="op">)</span>, color<span class="op">=</span><span class="st">"MLE"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">cols</span>, name<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">p5</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">plot.data</span>,
               <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">`psi[4]`</span>, color<span class="op">=</span><span class="st">"Posterior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span>data<span class="op">=</span><span class="va">prior.sig</span>,
            <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">sig</span>, y<span class="op">=</span><span class="va">dens.sig</span>, color<span class="op">=</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">MLE</span><span class="op">[</span><span class="fl">15</span>,<span class="fl">4</span><span class="op">]</span><span class="op">)</span>, color<span class="op">=</span><span class="st">"MLE"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">cols</span>, name<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">p6</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">plot.data</span>,
               <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">`psi[5]`</span>, color<span class="op">=</span><span class="st">"Posterior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span>data<span class="op">=</span><span class="va">prior.sig</span>,
            <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">sig</span>, y<span class="op">=</span><span class="va">dens.sig</span>, color<span class="op">=</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">MLE</span><span class="op">[</span><span class="fl">16</span>,<span class="fl">4</span><span class="op">]</span><span class="op">)</span>, color<span class="op">=</span><span class="st">"MLE"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">cols</span>, name<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span> <span class="op">+</span> <span class="va">p3</span> <span class="op">+</span> <span class="va">p4</span> <span class="op">+</span> <span class="va">p5</span> <span class="op">+</span> <span class="va">p6</span> <span class="op">+</span> <span class="fu">plot_layout</span><span class="op">(</span>guides <span class="op">=</span> <span class="st">"collect"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-stan-1-15.png" width="90%" height="90%"></div>
</div>
<div id="blavaan---single-latent-variable" class="section level2" number="9.4">
<h2>
<span class="header-section-number">9.4</span> Blavaan - Single Latent Variable<a class="anchor" aria-label="anchor" href="#blavaan---single-latent-variable"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb191"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># model</span>
<span class="va">model_cfa_blavaan</span> <span class="op">&lt;-</span> <span class="st">"
  f1 =~ 1*PI + AD + IGC + FI + FC
"</span>

<span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span><span class="op">(</span><span class="st">"code/CFA-Two-Latent-Variables/Data/IIS.dat"</span>, header<span class="op">=</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span>

<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">blavaan</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/blavaan/man/bcfa.html">bcfa</a></span><span class="op">(</span><span class="va">model_cfa_blavaan</span>, data<span class="op">=</span><span class="va">dat</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## SAMPLING FOR MODEL 'stanmarg' NOW (CHAIN 1).
## Chain 1: 
## Chain 1: Gradient evaluation took 0.001 seconds
## Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 10 seconds.
## Chain 1: Adjust your expectations accordingly!
## Chain 1: 
## Chain 1: 
## Chain 1: Iteration:    1 / 1500 [  0%]  (Warmup)
## Chain 1: Iteration:  150 / 1500 [ 10%]  (Warmup)
## Chain 1: Iteration:  300 / 1500 [ 20%]  (Warmup)
## Chain 1: Iteration:  450 / 1500 [ 30%]  (Warmup)
## Chain 1: Iteration:  501 / 1500 [ 33%]  (Sampling)
## Chain 1: Iteration:  650 / 1500 [ 43%]  (Sampling)
## Chain 1: Iteration:  800 / 1500 [ 53%]  (Sampling)
## Chain 1: Iteration:  950 / 1500 [ 63%]  (Sampling)
## Chain 1: Iteration: 1100 / 1500 [ 73%]  (Sampling)
## Chain 1: Iteration: 1250 / 1500 [ 83%]  (Sampling)
## Chain 1: Iteration: 1400 / 1500 [ 93%]  (Sampling)
## Chain 1: Iteration: 1500 / 1500 [100%]  (Sampling)
## Chain 1: 
## Chain 1:  Elapsed Time: 2.778 seconds (Warm-up)
## Chain 1:                5.302 seconds (Sampling)
## Chain 1:                8.08 seconds (Total)
## Chain 1: 
## 
## SAMPLING FOR MODEL 'stanmarg' NOW (CHAIN 2).
## Chain 2: 
## Chain 2: Gradient evaluation took 0 seconds
## Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 0 seconds.
## Chain 2: Adjust your expectations accordingly!
## Chain 2: 
## Chain 2: 
## Chain 2: Iteration:    1 / 1500 [  0%]  (Warmup)
## Chain 2: Iteration:  150 / 1500 [ 10%]  (Warmup)
## Chain 2: Iteration:  300 / 1500 [ 20%]  (Warmup)
## Chain 2: Iteration:  450 / 1500 [ 30%]  (Warmup)
## Chain 2: Iteration:  501 / 1500 [ 33%]  (Sampling)
## Chain 2: Iteration:  650 / 1500 [ 43%]  (Sampling)
## Chain 2: Iteration:  800 / 1500 [ 53%]  (Sampling)
## Chain 2: Iteration:  950 / 1500 [ 63%]  (Sampling)
## Chain 2: Iteration: 1100 / 1500 [ 73%]  (Sampling)
## Chain 2: Iteration: 1250 / 1500 [ 83%]  (Sampling)
## Chain 2: Iteration: 1400 / 1500 [ 93%]  (Sampling)
## Chain 2: Iteration: 1500 / 1500 [100%]  (Sampling)
## Chain 2: 
## Chain 2:  Elapsed Time: 2.809 seconds (Warm-up)
## Chain 2:                5.188 seconds (Sampling)
## Chain 2:                7.997 seconds (Total)
## Chain 2: 
## 
## SAMPLING FOR MODEL 'stanmarg' NOW (CHAIN 3).
## Chain 3: 
## Chain 3: Gradient evaluation took 0 seconds
## Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 0 seconds.
## Chain 3: Adjust your expectations accordingly!
## Chain 3: 
## Chain 3: 
## Chain 3: Iteration:    1 / 1500 [  0%]  (Warmup)
## Chain 3: Iteration:  150 / 1500 [ 10%]  (Warmup)
## Chain 3: Iteration:  300 / 1500 [ 20%]  (Warmup)
## Chain 3: Iteration:  450 / 1500 [ 30%]  (Warmup)
## Chain 3: Iteration:  501 / 1500 [ 33%]  (Sampling)
## Chain 3: Iteration:  650 / 1500 [ 43%]  (Sampling)
## Chain 3: Iteration:  800 / 1500 [ 53%]  (Sampling)
## Chain 3: Iteration:  950 / 1500 [ 63%]  (Sampling)
## Chain 3: Iteration: 1100 / 1500 [ 73%]  (Sampling)
## Chain 3: Iteration: 1250 / 1500 [ 83%]  (Sampling)
## Chain 3: Iteration: 1400 / 1500 [ 93%]  (Sampling)
## Chain 3: Iteration: 1500 / 1500 [100%]  (Sampling)
## Chain 3: 
## Chain 3:  Elapsed Time: 2.751 seconds (Warm-up)
## Chain 3:                5.192 seconds (Sampling)
## Chain 3:                7.943 seconds (Total)
## Chain 3: 
## Computing posterior predictives...</code></pre>
<div class="sourceCode" id="cb193"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></code></pre></div>
<pre><code>## blavaan (0.4-3) results of 1000 samples after 500 adapt/burnin iterations
## 
##   Number of observations                           500
## 
##   Number of missing patterns                         1
## 
##   Statistic                                 MargLogLik         PPP
##   Value                                      -2196.532       0.000
## 
## Latent Variables:
##                    Estimate  Post.SD pi.lower pi.upper     Rhat    Prior       
##   f1 =~                                                                        
##     PI                1.000                                                    
##     AD                0.847    0.056    0.743    0.964    1.002    normal(0,10)
##     IGC               0.494    0.043    0.414    0.579    1.003    normal(0,10)
##     FI                1.131    0.079    0.984    1.298    1.003    normal(0,10)
##     FC                1.090    0.074    0.955    1.252    1.003    normal(0,10)
## 
## Intercepts:
##                    Estimate  Post.SD pi.lower pi.upper     Rhat    Prior       
##    .PI                3.332    0.038    3.253    3.407    1.000    normal(0,32)
##    .AD                3.896    0.028    3.840    3.950    1.000    normal(0,32)
##    .IGC               4.595    0.022    4.554    4.638    1.000    normal(0,32)
##    .FI                3.032    0.042    2.952    3.112    1.000    normal(0,32)
##    .FC                3.711    0.037    3.637    3.783    1.000    normal(0,32)
##     f1                0.000                                                    
## 
## Variances:
##                    Estimate  Post.SD pi.lower pi.upper     Rhat    Prior       
##    .PI                0.353    0.026    0.305    0.407    1.001 gamma(1,.5)[sd]
##    .AD                0.120    0.012    0.097    0.145    1.000 gamma(1,.5)[sd]
##    .IGC               0.133    0.009    0.115    0.152    1.002 gamma(1,.5)[sd]
##    .FI                0.363    0.030    0.307    0.422    1.001 gamma(1,.5)[sd]
##    .FC                0.224    0.021    0.185    0.269    1.000 gamma(1,.5)[sd]
##     f1                0.337    0.041    0.259    0.423    1.002 gamma(1,.5)[sd]</code></pre>
<div class="sourceCode" id="cb195"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-blavaan-1-1.png" width="90%" height="90%"></div>
</div>
<div id="two-latent-variable-model" class="section level2" number="9.5">
<h2>
<span class="header-section-number">9.5</span> Two Latent Variable Model<a class="anchor" aria-label="anchor" href="#two-latent-variable-model"><i class="fas fa-link"></i></a>
</h2>
<p>Here we consider the model in section 9.4 which is a CFA model with 2 latent variables and 5 observed indicators.
The graphical representation of these factor models get pretty complex pretty quickly, but for this example I have reproduced a version of Figure 9.4, shown below.</p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:chp9-dag-2"></span>
<img src="dag/chp9-cfa2.png" alt="DAG for CFA model with 2 latent variables" width="75%" height="90%"><p class="caption">
Figure 9.4: DAG for CFA model with 2 latent variables
</p>
</div>
<p>However, as the authors noted, the path diagram tradition of conveying models is also very useful in discussing and describing the model, which I give next.</p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:chp9-pathdiag-2"></span>
<img src="path-diagram/chp9-cfa2.png" alt="Path Diagram for CFA model with 2 latent variables" width="90%" height="90%"><p class="caption">
Figure 9.5: Path Diagram for CFA model with 2 latent variables
</p>
</div>
<p>For completeness, I have included the model specification diagram that more concretely connects the DAG and path diagram to the assumed distributions and priors.</p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:chp9-spec-2"></span>
<img src="model-spec/chp9-cfa2.png" alt="Model specification diagram for the CFA model with 2 latent factors" width="90%" height="90%"><p class="caption">
Figure 9.6: Model specification diagram for the CFA model with 2 latent factors
</p>
</div>
</div>
<div id="jags---two-latent-variable" class="section level2" number="9.6">
<h2>
<span class="header-section-number">9.6</span> JAGS - Two Latent Variable<a class="anchor" aria-label="anchor" href="#jags---two-latent-variable"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb196"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># model code</span>
<span class="va">jags.model.cfa2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span>

  <span class="co">###################</span>
  <span class="co"># Specify the factor analysis measurement model for the observables</span>
  <span class="co">####################</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span><span class="op">{</span>
    
    <span class="co"># expected value for each examinee for each observable</span>
    <span class="va">mu</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">tau</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">lambda</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span><span class="op">*</span><span class="va">ksi</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span>    
    <span class="va">mu</span><span class="op">[</span><span class="va">i</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">tau</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="va">lambda</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span><span class="op">*</span><span class="va">ksi</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span>        
    <span class="va">mu</span><span class="op">[</span><span class="va">i</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">tau</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">+</span> <span class="va">lambda</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">1</span><span class="op">]</span><span class="op">*</span><span class="va">ksi</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span>          
    <span class="va">mu</span><span class="op">[</span><span class="va">i</span>,<span class="fl">4</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">tau</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span> <span class="op">+</span> <span class="va">lambda</span><span class="op">[</span><span class="fl">4</span>,<span class="fl">2</span><span class="op">]</span><span class="op">*</span><span class="va">ksi</span><span class="op">[</span><span class="va">i</span>,<span class="fl">2</span><span class="op">]</span>          
    <span class="va">mu</span><span class="op">[</span><span class="va">i</span>,<span class="fl">5</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">tau</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span> <span class="op">+</span> <span class="va">lambda</span><span class="op">[</span><span class="fl">5</span>,<span class="fl">2</span><span class="op">]</span><span class="op">*</span><span class="va">ksi</span><span class="op">[</span><span class="va">i</span>,<span class="fl">2</span><span class="op">]</span>          
    
    <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">J</span><span class="op">)</span><span class="op">{</span>
      <span class="va">x</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">mu</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span><span class="op">]</span>, <span class="va">inv.psi</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span>    <span class="co"># distribution for each observable</span>
    <span class="op">}</span>
  <span class="op">}</span>
  
  
  <span class="co">######################################################################</span>
  <span class="co"># Specify the (prior) distribution for the latent variables</span>
  <span class="co">######################################################################</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span><span class="op">{</span>
    <span class="va">ksi</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">:</span><span class="va">M</span><span class="op">]</span> <span class="op">~</span> <span class="fu">dmnorm</span><span class="op">(</span><span class="va">kappa</span><span class="op">[</span><span class="op">]</span>, <span class="va">inv.phi</span><span class="op">[</span>,<span class="op">]</span><span class="op">)</span>  <span class="co"># distribution for the latent variables</span>
  <span class="op">}</span>
  
  
  <span class="co">######################################################################</span>
  <span class="co"># Specify the prior distribution for the parameters that govern the latent variables</span>
  <span class="co">######################################################################</span>
  <span class="kw">for</span><span class="op">(</span><span class="va">m</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">M</span><span class="op">)</span><span class="op">{</span>
    <span class="va">kappa</span><span class="op">[</span><span class="va">m</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>              <span class="co"># Means of latent variables</span>
  <span class="op">}</span>
  
  <span class="va">inv.phi</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">M</span>,<span class="fl">1</span><span class="op">:</span><span class="va">M</span><span class="op">]</span> <span class="op">~</span> <span class="fu">dwish</span><span class="op">(</span><span class="va">dxphi.0</span><span class="op">[</span> , <span class="op">]</span>, <span class="va">d</span><span class="op">)</span>;    <span class="co"># prior for precision matrix for the latent variables</span>
  <span class="va">phi</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">M</span>,<span class="fl">1</span><span class="op">:</span><span class="va">M</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">inverse</span><span class="op">(</span><span class="va">inv.phi</span><span class="op">[</span> , <span class="op">]</span><span class="op">)</span>;        <span class="co"># the covariance matrix for the latent vars</span>
  
  <span class="va">phi.0</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span>;                  
  <span class="va">phi.0</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">.3</span>;                 
  <span class="va">phi.0</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">.3</span>;
  <span class="va">phi.0</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span>;
  <span class="va">d</span> <span class="op">&lt;-</span> <span class="fl">2</span>;                           
                              
  <span class="kw">for</span> <span class="op">(</span><span class="va">m</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">M</span><span class="op">)</span><span class="op">{</span>                       
       <span class="kw">for</span> <span class="op">(</span><span class="va">mm</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">M</span><span class="op">)</span><span class="op">{</span>
            <span class="va">dxphi.0</span><span class="op">[</span><span class="va">m</span>,<span class="va">mm</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">d</span><span class="op">*</span><span class="va">phi.0</span><span class="op">[</span><span class="va">m</span>,<span class="va">mm</span><span class="op">]</span>;
       <span class="op">}</span>
  <span class="op">}</span>
  
  
  
  <span class="co">######################################################################</span>
  <span class="co"># Specify the prior distribution for the measurement model parameters</span>
  <span class="co">######################################################################</span>
  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">J</span><span class="op">)</span><span class="op">{</span>
    <span class="va">tau</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">.1</span><span class="op">)</span>        <span class="co"># Intercepts for observables</span>
    <span class="va">inv.psi</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html">dgamma</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span> <span class="co"># Precisions for observables</span>
    <span class="va">psi</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="va">inv.psi</span><span class="op">[</span><span class="va">j</span><span class="op">]</span>   <span class="co"># Variances for observables</span>
  <span class="op">}</span>
  
  <span class="va">lambda</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1.0</span>              <span class="co"># loading fixed to 1.0 </span>
  <span class="va">lambda</span><span class="op">[</span><span class="fl">4</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1.0</span>              <span class="co"># loading fixed to 1.0 </span>
  
  <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span><span class="op">{</span>
    <span class="va">lambda</span><span class="op">[</span><span class="va">j</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">.1</span><span class="op">)</span>    <span class="co"># prior distribution for the remaining loadings</span>
  <span class="op">}</span>
  <span class="va">lambda</span><span class="op">[</span><span class="fl">5</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">.1</span><span class="op">)</span>      <span class="co"># prior distribution for the remaining loadings</span>
<span class="op">}</span>
<span class="co"># data must be in a list</span>
<span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span><span class="op">(</span><span class="st">"code/CFA-One-Latent-Variable/Data/IIS.dat"</span>, header<span class="op">=</span><span class="cn">T</span><span class="op">)</span>

<span class="va">mydata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  n <span class="op">=</span> <span class="fl">500</span>, J <span class="op">=</span> <span class="fl">5</span>, M <span class="op">=</span><span class="fl">2</span>,
  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span>
<span class="op">)</span>


<span class="co"># initial values</span>
<span class="va">start_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"tau"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1.00E-01</span>, <span class="fl">1.00E-01</span>, <span class="fl">1.00E-01</span>, <span class="fl">1.00E-01</span>, <span class="fl">1.00E-01</span><span class="op">)</span>,
       lambda<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html">structure</a></span><span class="op">(</span>
         .Data<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span> <span class="cn">NA</span>,  <span class="fl">2.00E+00</span>, <span class="fl">2.00E+00</span>, <span class="cn">NA</span>, <span class="cn">NA</span>,
                   <span class="cn">NA</span>,  <span class="cn">NA</span>,  <span class="cn">NA</span>,  <span class="cn">NA</span>, <span class="fl">2.00E+00</span><span class="op">)</span>,
         .Dim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>,
       inv.phi<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html">structure</a></span><span class="op">(</span>
         .Data<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1.00E+00</span>, <span class="fl">0.00E+00</span>, <span class="fl">0.00E+00</span>, <span class="fl">1.00E+00</span><span class="op">)</span>,
         .Dim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>,
       inv.psi<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1.00E+00</span>, <span class="fl">1.00E+00</span>, <span class="fl">1.00E+00</span>, <span class="fl">1.00E+00</span>, <span class="fl">1.00E+00</span><span class="op">)</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>tau<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3.00E+00</span>, <span class="fl">3.00E+00</span>, <span class="fl">3.00E+00</span>, <span class="fl">3.00E+00</span>, <span class="fl">3.00E+00</span><span class="op">)</span>,
       lambda<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html">structure</a></span><span class="op">(</span>
         .Data<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span> <span class="cn">NA</span>,  <span class="fl">5.00E-01</span>, <span class="fl">5.00E-01</span>,  <span class="cn">NA</span>, <span class="cn">NA</span>, 
                   <span class="cn">NA</span>,  <span class="cn">NA</span>,  <span class="cn">NA</span>,  <span class="cn">NA</span>, <span class="fl">5.00E-01</span><span class="op">)</span>,
         .Dim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>,
       inv.phi<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html">structure</a></span><span class="op">(</span>
         .Data<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1.33E+00</span>, <span class="op">-</span><span class="fl">6.67E-01</span>, <span class="op">-</span><span class="fl">6.67E-01</span>, <span class="fl">1.33E+00</span><span class="op">)</span>,
         .Dim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>,
       inv.psi<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2.00E+00</span>, <span class="fl">2.00E+00</span>, <span class="fl">2.00E+00</span>, <span class="fl">2.00E+00</span>, <span class="fl">2.00E+00</span><span class="op">)</span><span class="op">)</span>
,
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>tau<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5.00E+00</span>, <span class="fl">5.00E+00</span>, <span class="fl">5.00E+00</span>, <span class="fl">5.00E+00</span>, <span class="fl">5.00E+00</span><span class="op">)</span>,
       lambda<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html">structure</a></span><span class="op">(</span>
         .Data<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span> <span class="cn">NA</span>,  <span class="fl">1.00E+00</span>, <span class="fl">1.00E+00</span>,  <span class="cn">NA</span>, <span class="cn">NA</span>,
                   <span class="cn">NA</span>,  <span class="cn">NA</span>,  <span class="cn">NA</span>,  <span class="cn">NA</span>, <span class="fl">1.00E+00</span><span class="op">)</span>,
         .Dim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>,
       inv.phi<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html">structure</a></span><span class="op">(</span>
         .Data<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1.96E+00</span>, <span class="op">-</span><span class="fl">1.37E+00</span>, <span class="op">-</span><span class="fl">1.37E+00</span>, <span class="fl">1.96E+00</span><span class="op">)</span>,
         .Dim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>,
       inv.psi<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5.00E-01</span>, <span class="fl">5.00E-01</span>, <span class="fl">5.00E-01</span>, <span class="fl">5.00E-01</span>, <span class="fl">5.00E-01</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># vector of all parameters to save</span>
<span class="co"># exclude fixed lambda since it throws an error in</span>
<span class="co"># in the GRB plot</span>
<span class="va">param_save</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"tau"</span>, <span class="st">"lambda[2,1]"</span>,<span class="st">"lambda[3,1]"</span>,<span class="st">"lambda[5,2]"</span>, <span class="st">"phi"</span>, <span class="st">"psi"</span><span class="op">)</span>

<span class="co"># fit model</span>
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">jags</span><span class="op">(</span>
  model.file<span class="op">=</span><span class="va">jags.model.cfa2</span>,
  data<span class="op">=</span><span class="va">mydata</span>,
  inits<span class="op">=</span><span class="va">start_values</span>,
  parameters.to.save <span class="op">=</span> <span class="va">param_save</span>,
  n.iter<span class="op">=</span><span class="fl">5000</span>,
  n.burnin <span class="op">=</span> <span class="fl">2500</span>,
  n.chains <span class="op">=</span> <span class="fl">3</span>,
  n.thin<span class="op">=</span><span class="fl">1</span>,
  progress.bar <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></code></pre></div>
<pre><code>## Compiling model graph
##    Resolving undeclared variables
##    Allocating nodes
## Graph information:
##    Observed stochastic nodes: 2500
##    Unobserved stochastic nodes: 514
##    Total graph size: 9035
## 
## Initializing model</code></pre>
<div class="sourceCode" id="cb198"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></code></pre></div>
<pre><code>## Inference for Bugs model at "C:/Users/noahp/AppData/Local/Temp/RtmpaGlb2m/model324448313258.txt", fit using jags,
##  3 chains, each with 5000 iterations (first 2500 discarded)
##  n.sims = 7500 iterations saved
##              mu.vect sd.vect     2.5%      25%      50%      75%    97.5%  Rhat n.eff
## lambda[2,1]    0.782   0.117    0.678    0.738    0.771    0.809    0.892 1.028   440
## lambda[3,1]    0.466   0.097    0.382    0.431    0.459    0.488    0.555 1.031   820
## lambda[5,2]    0.929   0.150    0.817    0.880    0.915    0.953    1.037 1.005  7500
## phi[1,1]       0.380   0.053    0.293    0.351    0.381    0.411    0.472 1.005   650
## phi[2,1]       0.375   0.048    0.303    0.352    0.376    0.402    0.453 1.002  2600
## phi[1,2]       0.375   0.048    0.303    0.352    0.376    0.402    0.453 1.002  2600
## phi[2,2]       0.493   0.066    0.393    0.461    0.495    0.531    0.602 1.001  7500
## psi[1]         0.368   0.035    0.310    0.346    0.365    0.386    0.432 1.003   850
## psi[2]         0.173   0.174    0.144    0.161    0.170    0.179    0.199 1.017  7500
## psi[3]         0.174   0.241    0.149    0.163    0.171    0.179    0.196 1.040  2100
## psi[4]         0.343   0.125    0.284    0.318    0.338    0.359    0.405 1.005  7500
## psi[5]         0.245   0.141    0.204    0.228    0.242    0.257    0.288 1.006  7500
## tau[1]         3.334   0.038    3.260    3.308    3.334    3.360    3.410 1.001  7500
## tau[2]         3.898   0.028    3.843    3.879    3.898    3.917    3.953 1.001  7500
## tau[3]         4.596   0.023    4.551    4.581    4.596    4.611    4.640 1.001  7500
## tau[4]         3.034   0.041    2.955    3.007    3.034    3.062    3.115 1.001  7500
## tau[5]         3.713   0.036    3.641    3.689    3.713    3.738    3.784 1.001  7500
## deviance    3189.610 134.312 3072.986 3145.423 3182.566 3223.278 3306.219 1.011  7500
## 
## For each parameter, n.eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor (at convergence, Rhat=1).
## 
## DIC info (using the rule, pD = var(deviance)/2)
## pD = 9022.3 and DIC = 12211.9
## DIC is an estimate of expected predictive error (lower deviance is better).</code></pre>
<div class="sourceCode" id="cb200"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># extract posteriors for all chains</span>
<span class="va">jags.mcmc</span> <span class="op">&lt;-</span> <span class="fu">as.mcmc</span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>

<span class="fu">R2jags</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/R2jags/man/traceplot.html">traceplot</a></span><span class="op">(</span><span class="va">jags.mcmc</span><span class="op">)</span></code></pre></div>
<p><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-2-1.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-2-2.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-2-3.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-2-4.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-2-5.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-2-6.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-2-7.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-2-8.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-2-9.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-2-10.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-2-11.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-2-12.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-2-13.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-2-14.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-2-15.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-2-16.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-2-17.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-2-18.png" width="90%" height="90%"></p>
<div class="sourceCode" id="cb201"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># gelman-rubin-brook</span>
<span class="fu">gelman.plot</span><span class="op">(</span><span class="va">jags.mcmc</span><span class="op">)</span></code></pre></div>
<p><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-2-19.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-2-20.png" width="90%" height="90%"></p>
<div class="sourceCode" id="cb202"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># convert to single data.frame for density plot</span>
<span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">jags.mcmc</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
<span class="va">plot.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">jags.mcmc</span>, chains<span class="op">=</span><span class="cn">T</span>, iters <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">plot.data</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"chain"</span>, <span class="st">"iter"</span>, <span class="va">a</span><span class="op">)</span>


<span class="va">plot_title</span> <span class="op">&lt;-</span> <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Posterior distributions"</span>,
                      <span class="st">"with medians and 80% intervals"</span><span class="op">)</span>
<span class="fu">mcmc_areas</span><span class="op">(</span>
  <span class="va">plot.data</span>,
  pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"tau["</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="st">"]"</span><span class="op">)</span><span class="op">)</span>,
  prob <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span>
  <span class="va">plot_title</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-2-21.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb203"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">mcmc_areas</span><span class="op">(</span>
  <span class="va">plot.data</span>,
  pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lambda[2,1]"</span>,<span class="st">"lambda[3,1]"</span>,<span class="st">"lambda[5,2]"</span><span class="op">)</span>,
  prob <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span>
  <span class="va">plot_title</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-2-22.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb204"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">mcmc_areas</span><span class="op">(</span>
  <span class="va">plot.data</span>,
  pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"psi["</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="st">"]"</span><span class="op">)</span>, <span class="st">"phi[1,1]"</span>, <span class="st">"phi[1,2]"</span>,<span class="st">"phi[2,2]"</span><span class="op">)</span>,
  prob <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span>
  <span class="va">plot_title</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-2-23.png" width="90%" height="90%"></div>
</div>
<div id="stan---two-latent-variable" class="section level2" number="9.7">
<h2>
<span class="header-section-number">9.7</span> Stan - Two Latent Variable<a class="anchor" aria-label="anchor" href="#stan---two-latent-variable"><i class="fas fa-link"></i></a>
</h2>
<div id="inverse-wishart-prior" class="section level3" number="9.7.1">
<h3>
<span class="header-section-number">9.7.1</span> Inverse-Wishart Prior<a class="anchor" aria-label="anchor" href="#inverse-wishart-prior"><i class="fas fa-link"></i></a>
</h3>
<p>Using Stan based on a nearly identical model structure presented in the text.</p>
<div class="sourceCode" id="cb205"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model_cfa_2factor</span> <span class="op">&lt;-</span> <span class="st">[1051 chars quoted with '"']</span>

<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="va">model_cfa_2factor</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## data {
##   int  N;
##   int  J;
##   int  M;
##   matrix[N, J] X;
##   matrix[M, M] phi0;
## }
## 
## parameters {
##   matrix[M, M] phi; // latent variable covaraince matrix
##   matrix[N, M] ksi; //latent variable values
##   real lambda[J]; //factor loadings matrix
##   real tau[J]; //intercepts
##   real&lt;lower=0&gt; psi[J]; //residual variance
## }
## 
## model {
##   // likelihood for data
##   for(i in 1:N){
##     X[i, 1] ~ normal(tau[1] + ksi[i,1]*lambda[1], psi[1]);
##     X[i, 2] ~ normal(tau[2] + ksi[i,1]*lambda[2], psi[2]);
##     X[i, 3] ~ normal(tau[3] + ksi[i,1]*lambda[3], psi[3]);
##     X[i, 4] ~ normal(tau[4] + ksi[i,2]*lambda[4], psi[4]);
##     X[i, 5] ~ normal(tau[5] + ksi[i,2]*lambda[5], psi[5]);
##     
##     // prior for ksi
##     ksi[i] ~ multi_normal(rep_vector(0, M), phi);
##   }
##   // latent variable variance matrix
##   phi  ~ inv_wishart(2, phi0);
##   // prior for measurement model parameters
##   tau ~ normal(3, 10);
##   psi ~ inv_gamma(5, 10);
##   lambda[1] ~ normal(1, .001);
##   lambda[2] ~ normal(1, 10);
##   lambda[3] ~ normal(1, 10);
##   lambda[4] ~ normal(1, .001);
##   lambda[5] ~ normal(1, 10);
## }</code></pre>
<div class="sourceCode" id="cb207"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># data must be in a list</span>
<span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span><span class="op">(</span><span class="st">"code/CFA-Two-Latent-Variables/Data/IIS.dat"</span>, header<span class="op">=</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span>

<span class="va">mydata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  N <span class="op">=</span> <span class="fl">500</span>, J <span class="op">=</span> <span class="fl">5</span>,
  M <span class="op">=</span> <span class="fl">2</span>,
  X <span class="op">=</span> <span class="va">dat</span>,
  phi0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">.3</span>, <span class="fl">.3</span>, <span class="fl">1</span><span class="op">)</span>, ncol<span class="op">=</span><span class="fl">2</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># # initial values</span>
<span class="va">start_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    phi<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html">structure</a></span><span class="op">(</span>
      .Data<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.30</span>, <span class="fl">0.30</span>, <span class="fl">1</span><span class="op">)</span>,
      .Dim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>,
    tau <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">3</span>, <span class="fl">3</span>, <span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span>,
    lambda<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>,
    psi<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.5</span>, <span class="fl">.5</span>, <span class="fl">.5</span>, <span class="fl">.5</span>, <span class="fl">.5</span><span class="op">)</span>
  <span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    phi<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html">structure</a></span><span class="op">(</span>
      .Data<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,
      .Dim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>,
    tau <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">5</span>, <span class="fl">5</span>, <span class="fl">5</span>, <span class="fl">5</span><span class="op">)</span>,
    lambda<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">.7</span>, <span class="fl">.7</span>, <span class="fl">1</span>, <span class="fl">.7</span><span class="op">)</span>,
    psi<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>
  <span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    phi<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/structure.html">structure</a></span><span class="op">(</span>
      .Data<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.10</span>, <span class="fl">0.10</span>, <span class="fl">1</span><span class="op">)</span>,
      .Dim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>,
    tau <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>,
    lambda<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1.3</span>, <span class="fl">1.3</span>, <span class="fl">1</span>, <span class="fl">1.3</span><span class="op">)</span>,
    psi<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span>

<span class="co"># Next, need to fit the model</span>
<span class="co">#   I have explicitly outlined some common parameters</span>
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">stan</span><span class="op">(</span>
  model_code <span class="op">=</span> <span class="va">model_cfa_2factor</span>, <span class="co"># model code to be compiled</span>
  data <span class="op">=</span> <span class="va">mydata</span>,          <span class="co"># my data</span>
  init <span class="op">=</span> <span class="va">start_values</span>,    <span class="co"># starting values</span>
  chains<span class="op">=</span><span class="fl">3</span>,
  refresh <span class="op">=</span> <span class="fl">0</span>             <span class="co"># no progress shown</span>
<span class="op">)</span></code></pre></div>
<pre><code>## Warning: There were 2983 divergent transitions after warmup. See
## https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup
## to find out why this is a problem and how to eliminate them.</code></pre>
<pre><code>## Warning: There were 17 transitions after warmup that exceeded the maximum treedepth. Increase max_treedepth above 10. See
## https://mc-stan.org/misc/warnings.html#maximum-treedepth-exceeded</code></pre>
<pre><code>## Warning: Examine the pairs() plot to diagnose sampling problems</code></pre>
<pre><code>## Warning: The largest R-hat is 3.78, indicating chains have not mixed.
## Running the chains for more iterations may help. See
## https://mc-stan.org/misc/warnings.html#r-hat</code></pre>
<pre><code>## Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
## Running the chains for more iterations may help. See
## https://mc-stan.org/misc/warnings.html#bulk-ess</code></pre>
<pre><code>## Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
## Running the chains for more iterations may help. See
## https://mc-stan.org/misc/warnings.html#tail-ess</code></pre>
<div class="sourceCode" id="cb214"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># first get a basic breakdown of the posteriors</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">fit</span>, 
      pars <span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lambda"</span>, <span class="st">"tau"</span>, <span class="st">"psi"</span>,
              <span class="st">"phi"</span>,
              <span class="st">"ksi[1, 1]"</span>, <span class="st">"ksi[1, 2]"</span>,
              <span class="st">"ksi[8, 1]"</span>, <span class="st">"ksi[8, 2]"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## Inference for Stan model: anon_model.
## 3 chains, each with iter=2000; warmup=1000; thin=1; 
## post-warmup draws per chain=1000, total post-warmup draws=3000.
## 
##            mean se_mean   sd  2.5%   25%  50%  75% 97.5% n_eff       Rhat
## lambda[1]  1.00    0.00 0.00  1.00  1.00 1.00 1.00  1.00     2       3.43
## lambda[2]  1.00    0.20 0.24  0.70  0.70 1.00 1.30  1.30     2  688044.85
## lambda[3]  1.00    0.20 0.24  0.70  0.70 1.00 1.30  1.30     2  571252.30
## lambda[4]  1.00    0.00 0.00  1.00  1.00 1.00 1.00  1.00     2       8.82
## lambda[5]  1.00    0.20 0.24  0.70  0.70 1.00 1.30  1.30     2  828681.14
## tau[1]     3.00    1.33 1.63  1.00  1.00 3.00 5.00  5.00     2 6408079.17
## tau[2]     3.00    1.33 1.63  1.00  1.00 3.00 5.00  5.00     2 4018815.25
## tau[3]     3.00    1.33 1.63  1.00  1.00 3.00 5.00  5.00     2 4477733.07
## tau[4]     3.00    1.33 1.63  1.00  1.00 3.00 5.00  5.00     2 5380093.58
## tau[5]     3.00    1.33 1.63  1.00  1.00 3.00 5.00  5.00     2 2626323.63
## psi[1]     1.17    0.51 0.62  0.50  0.50 1.00 2.00  2.00     2 1360074.81
## psi[2]     1.17    0.51 0.62  0.50  0.50 1.00 2.00  2.00     2 1250198.67
## psi[3]     1.17    0.51 0.62  0.50  0.50 1.00 2.00  2.00     2 1082592.54
## psi[4]     1.17    0.51 0.62  0.50  0.50 1.00 2.00  2.00     2 1498131.27
## psi[5]     1.17    0.51 0.62  0.50  0.50 1.00 2.00  2.00     2 1034527.28
## phi[1,1]   1.00    0.00 0.00  1.00  1.00 1.00 1.00  1.00     3       1.55
## phi[1,2]   0.13    0.10 0.12  0.00  0.00 0.10 0.30  0.30     2  388039.24
## phi[2,1]   0.13    0.10 0.12  0.00  0.00 0.10 0.30  0.30     2  387623.00
## phi[2,2]   1.00    0.00 0.00  1.00  1.00 1.00 1.00  1.00     2       9.66
## ksi[1,1]   0.59    0.50 0.62 -0.28 -0.28 0.95 1.10  1.10     2 2255396.84
## ksi[1,2]  -0.33    0.89 1.08 -1.84 -1.84 0.18 0.66  0.66     2 3056164.29
## ksi[8,1]   0.13    0.69 0.85 -0.91 -0.91 0.12 1.18  1.18     2 2760193.16
## ksi[8,2]   0.40    0.34 0.41 -0.10 -0.10 0.39 0.91  0.91     2  571386.66
## 
## Samples were drawn using NUTS(diag_e) at Mon Jun 20 03:45:25 2022.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
<div class="sourceCode" id="cb216"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># plot the posterior in a</span>
<span class="co">#  95% probability interval</span>
<span class="co">#  and 80% to contrast the dispersion</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fit</span>,
     pars <span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lambda"</span>, <span class="st">"tau"</span>, <span class="st">"psi"</span>,
              <span class="st">"phi"</span>,
              <span class="st">"ksi[1, 1]"</span>, <span class="st">"ksi[1, 2]"</span>,
              <span class="st">"ksi[8, 1]"</span>, <span class="st">"ksi[8, 2]"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## ci_level: 0.8 (80% intervals)</code></pre>
<pre><code>## outer_level: 0.95 (95% intervals)</code></pre>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-stan-2-1.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb219"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># traceplots</span>
<span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-traceplot.html">traceplot</a></span><span class="op">(</span>
  <span class="va">fit</span>,
  pars <span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lambda"</span>, <span class="st">"tau"</span>, <span class="st">"psi"</span>,
              <span class="st">"phi"</span>,
              <span class="st">"ksi[1, 1]"</span>, <span class="st">"ksi[1, 2]"</span>,
              <span class="st">"ksi[8, 1]"</span>, <span class="st">"ksi[8, 2]"</span><span class="op">)</span>,
  inc_warmup <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-stan-2-2.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb220"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Gelman-Rubin-Brooks Convergence Criterion</span>
<span class="fu">ggs_grb</span><span class="op">(</span><span class="fu">ggs</span><span class="op">(</span><span class="va">fit</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lambda"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
   <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-stan-2-3.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb221"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggs_grb</span><span class="op">(</span><span class="fu">ggs</span><span class="op">(</span><span class="va">fit</span>, family <span class="op">=</span> <span class="st">"tau"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
   <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-stan-2-4.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb222"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggs_grb</span><span class="op">(</span><span class="fu">ggs</span><span class="op">(</span><span class="va">fit</span>, family <span class="op">=</span> <span class="st">"psi"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
   <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-stan-2-5.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb223"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggs_grb</span><span class="op">(</span><span class="fu">ggs</span><span class="op">(</span><span class="va">fit</span>, family <span class="op">=</span> <span class="st">"phi"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
   <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-stan-2-6.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb224"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># autocorrelation</span>
<span class="fu">ggs_autocorrelation</span><span class="op">(</span><span class="fu">ggs</span><span class="op">(</span><span class="va">fit</span>, family<span class="op">=</span><span class="st">"lambda"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
   <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-stan-2-7.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb225"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggs_autocorrelation</span><span class="op">(</span><span class="fu">ggs</span><span class="op">(</span><span class="va">fit</span>, family<span class="op">=</span><span class="st">"tau"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
   <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-stan-2-8.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb226"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggs_autocorrelation</span><span class="op">(</span><span class="fu">ggs</span><span class="op">(</span><span class="va">fit</span>, family<span class="op">=</span><span class="st">"psi"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
   <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-stan-2-9.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb227"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggs_autocorrelation</span><span class="op">(</span><span class="fu">ggs</span><span class="op">(</span><span class="va">fit</span>, family<span class="op">=</span><span class="st">"phi"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
   <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-stan-2-10.png" width="90%" height="90%"></div>
</div>
<div id="lkj-cholesky-parameterization" class="section level3" number="9.7.2">
<h3>
<span class="header-section-number">9.7.2</span> LKJ Cholesky Parameterization<a class="anchor" aria-label="anchor" href="#lkj-cholesky-parameterization"><i class="fas fa-link"></i></a>
</h3>
<p>Because I had such massive problems with the above, I search for how people estimate CFA models in Stan.
I found that most people use the LKJ Cholesky parameterization.</p>
<p>Some helpful pages that I used to help get this to work.</p>
<ul>
<li><a href="https://mc-stan.org/docs/2_24/stan-users-guide/loading-matrix-for-factor-analysis.html">Stan User’s Guide on Factor Covaraince Parameterization</a></li>
<li><a href="https://michaeldewittjr.com/resources/stan_cfa.html#bayesian_version">Michael DeWitt - Confirmatory Factor Analysis in Stan</a></li>
<li><a href="https://rfarouni.github.io/assets/projects/BayesianFactorAnalysis/BayesianFactorAnalysis.html">Rick Farouni - Fitting a Bayesian Factor Analysis Model in Stan</a></li>
</ul>
<div class="sourceCode" id="cb228"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model_cfa2</span> <span class="op">&lt;-</span> <span class="st">[1409 chars quoted with '"']</span>

<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="va">model_cfa2</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## data {
##   int  N;
##   int  J;
##   int  M;
##   matrix[N, J] X;
## }
## 
## parameters {
##   cholesky_factor_corr[M] L; // Cholesky decomp of 
##                               // corr mat of random slopes
##   vector[M] A; // Vector of factor variances
##   matrix[N, M] ksi; //latent variable values
##   vector[J] lambda; //factor loadings matrix
##   real tau[J]; //intercepts
##   real&lt;lower=0&gt; psi[J]; //residual variance
## }
## 
## transformed parameters {
##   matrix[M, M] A0;
##   vector[M] S;
##   A0 = diag_pre_multiply(A, L);
##   S = sqrt(A);
## }
## 
## model {
##   
##   // likelihood for data
##   for(i in 1:N){
##     X[i, 1] ~ normal(tau[1] + ksi[i,1]*lambda[1], psi[1]);
##     X[i, 2] ~ normal(tau[2] + ksi[i,1]*lambda[2], psi[2]);
##     X[i, 3] ~ normal(tau[3] + ksi[i,1]*lambda[3], psi[3]);
##     X[i, 4] ~ normal(tau[4] + ksi[i,2]*lambda[4], psi[4]);
##     X[i, 5] ~ normal(tau[5] + ksi[i,2]*lambda[5], psi[5]);
##   }
##   // latent variable parameters
##   A ~ inv_gamma(5, 10);
##   L ~ lkj_corr_cholesky(M);
##   for(i in 1:N){
##     ksi[i] ~ multi_normal_cholesky(rep_vector(0, M), A0);
##   }
##   // prior for measurement model parameters
##   tau ~ normal(3, 10);
##   psi ~ inv_gamma(5, 10);
##   // factor loading patterns
##   lambda[1] ~ normal(1, .001);
##   lambda[2] ~ normal(1, 10);
##   lambda[3] ~ normal(1, 10);
##   lambda[4] ~ normal(1, .001);
##   lambda[5] ~ normal(1, 10);
## }
## 
## generated quantities {
##   matrix[M, M] R;
##   matrix[M, M] phi;
##   
##   R = tcrossprod(L);
##   phi = quad_form_diag(R, S);
## }</code></pre>
<div class="sourceCode" id="cb230"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># data must be in a list</span>
<span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span><span class="op">(</span><span class="st">"code/CFA-Two-Latent-Variables/Data/IIS.dat"</span>, header<span class="op">=</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span>

<span class="va">mydata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  N <span class="op">=</span> <span class="fl">500</span>, J <span class="op">=</span> <span class="fl">5</span>,
  M <span class="op">=</span> <span class="fl">2</span>,
  X <span class="op">=</span> <span class="va">dat</span>
<span class="op">)</span>

<span class="co"># Next, need to fit the model</span>
<span class="co">#   I have explicitly outlined some common parameters</span>
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">stan</span><span class="op">(</span>
  model_code <span class="op">=</span> <span class="va">model_cfa2</span>, <span class="co"># model code to be compiled</span>
  data <span class="op">=</span> <span class="va">mydata</span>,          <span class="co"># my data</span>
  <span class="co">#init = init_fun, #start_values,    # starting values</span>
  refresh <span class="op">=</span> <span class="fl">0</span>             <span class="co"># no progress shown</span>
<span class="op">)</span></code></pre></div>
<pre><code>## Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
## Running the chains for more iterations may help. See
## https://mc-stan.org/misc/warnings.html#bulk-ess</code></pre>
<div class="sourceCode" id="cb232"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># first get a basic breakdown of the posteriors</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">fit</span>, 
      pars <span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lambda"</span>, <span class="st">"tau"</span>, <span class="st">"psi"</span>,
              <span class="st">"R"</span>, <span class="st">"A"</span>, <span class="st">"A0"</span>, <span class="st">"phi"</span>,
              <span class="st">"ksi[1, 1]"</span>, <span class="st">"ksi[1, 2]"</span>,
              <span class="st">"ksi[8, 1]"</span>, <span class="st">"ksi[8, 2]"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## Inference for Stan model: anon_model.
## 4 chains, each with iter=2000; warmup=1000; thin=1; 
## post-warmup draws per chain=1000, total post-warmup draws=4000.
## 
##            mean se_mean   sd  2.5%   25%   50%   75% 97.5% n_eff Rhat
## lambda[1]  1.00       0 0.00  1.00  1.00  1.00  1.00  1.00  4475 1.00
## lambda[2]  0.87       0 0.06  0.76  0.83  0.87  0.91  0.98   694 1.00
## lambda[3]  0.52       0 0.04  0.44  0.49  0.52  0.54  0.60   995 1.00
## lambda[4]  1.00       0 0.00  1.00  1.00  1.00  1.00  1.00  4225 1.00
## lambda[5]  0.96       0 0.05  0.86  0.92  0.96  1.00  1.07   849 1.00
## tau[1]     3.33       0 0.04  3.25  3.31  3.33  3.36  3.40  1067 1.00
## tau[2]     3.90       0 0.03  3.84  3.88  3.90  3.91  3.95   864 1.00
## tau[3]     4.60       0 0.02  4.55  4.58  4.60  4.61  4.64  1321 1.00
## tau[4]     3.03       0 0.04  2.95  3.00  3.03  3.06  3.11   998 1.00
## tau[5]     3.71       0 0.04  3.64  3.69  3.71  3.73  3.78   887 1.00
## psi[1]     0.61       0 0.02  0.56  0.59  0.61  0.62  0.65  2275 1.00
## psi[2]     0.32       0 0.02  0.28  0.31  0.32  0.33  0.36  1143 1.00
## psi[3]     0.36       0 0.01  0.33  0.35  0.36  0.36  0.38  2890 1.00
## psi[4]     0.57       0 0.03  0.52  0.55  0.56  0.58  0.62  2336 1.00
## psi[5]     0.42       0 0.03  0.37  0.41  0.42  0.44  0.47  1238 1.00
## R[1,1]     1.00     NaN 0.00  1.00  1.00  1.00  1.00  1.00   NaN  NaN
## R[1,2]     0.86       0 0.03  0.80  0.84  0.86  0.88  0.91   601 1.01
## R[2,1]     0.86       0 0.03  0.80  0.84  0.86  0.88  0.91   601 1.01
## R[2,2]     1.00     NaN 0.00  1.00  1.00  1.00  1.00  1.00   NaN  NaN
## A[1]       0.60       0 0.04  0.53  0.58  0.60  0.62  0.67   840 1.00
## A[2]       0.71       0 0.04  0.64  0.68  0.71  0.73  0.78  1216 1.00
## A0[1,1]    0.60       0 0.04  0.53  0.58  0.60  0.62  0.67   840 1.00
## A0[1,2]    0.00     NaN 0.00  0.00  0.00  0.00  0.00  0.00   NaN  NaN
## A0[2,1]    0.61       0 0.04  0.53  0.58  0.61  0.63  0.68  1440 1.00
## A0[2,2]    0.36       0 0.04  0.29  0.34  0.36  0.39  0.43   501 1.01
## phi[1,1]   0.60       0 0.04  0.53  0.58  0.60  0.62  0.67   840 1.00
## phi[1,2]   0.56       0 0.03  0.50  0.54  0.56  0.58  0.63  1062 1.00
## phi[2,1]   0.56       0 0.03  0.50  0.54  0.56  0.58  0.63  1062 1.00
## phi[2,2]   0.71       0 0.04  0.64  0.68  0.71  0.73  0.78  1216 1.00
## ksi[1,1]  -0.22       0 0.23 -0.66 -0.38 -0.22 -0.06  0.24  6673 1.00
## ksi[1,2]  -0.37       0 0.28 -0.92 -0.56 -0.36 -0.18  0.17  7072 1.00
## ksi[8,1]   0.92       0 0.24  0.46  0.75  0.92  1.07  1.39  5711 1.00
## ksi[8,2]   0.88       0 0.27  0.35  0.70  0.89  1.06  1.42  7048 1.00
## 
## Samples were drawn using NUTS(diag_e) at Mon Jun 20 03:53:27 2022.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
<div class="sourceCode" id="cb234"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># plot the posterior in a</span>
<span class="co">#  95% probability interval</span>
<span class="co">#  and 80% to contrast the dispersion</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fit</span>,pars <span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lambda"</span>, <span class="st">"tau"</span>, <span class="st">"psi"</span>,
                 <span class="st">"phi"</span>,
              <span class="st">"ksi[1, 1]"</span>, <span class="st">"ksi[1, 2]"</span>,
              <span class="st">"ksi[8, 1]"</span>, <span class="st">"ksi[8, 2]"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## ci_level: 0.8 (80% intervals)</code></pre>
<pre><code>## outer_level: 0.95 (95% intervals)</code></pre>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-stan-3-1.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb237"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># traceplots</span>
<span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-traceplot.html">traceplot</a></span><span class="op">(</span><span class="va">fit</span>,
      pars <span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lambda"</span>, <span class="st">"tau"</span>, <span class="st">"psi"</span>,
              <span class="st">"phi"</span>,
              <span class="st">"ksi[1, 1]"</span>, <span class="st">"ksi[1, 2]"</span>,
              <span class="st">"ksi[8, 1]"</span>, <span class="st">"ksi[8, 2]"</span><span class="op">)</span>, inc_warmup <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-stan-3-2.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb238"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Gelman-Rubin-Brooks Convergence Criterion</span>
<span class="fu">ggs_grb</span><span class="op">(</span><span class="fu">ggs</span><span class="op">(</span><span class="va">fit</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lambda"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
   <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-stan-3-3.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb239"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggs_grb</span><span class="op">(</span><span class="fu">ggs</span><span class="op">(</span><span class="va">fit</span>, family <span class="op">=</span> <span class="st">"tau"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
   <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-stan-3-4.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb240"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggs_grb</span><span class="op">(</span><span class="fu">ggs</span><span class="op">(</span><span class="va">fit</span>, family <span class="op">=</span> <span class="st">"psi"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
   <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-stan-3-5.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb241"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggs_grb</span><span class="op">(</span><span class="fu">ggs</span><span class="op">(</span><span class="va">fit</span>, family <span class="op">=</span> <span class="st">"phi"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
   <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-stan-3-6.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb242"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># autocorrelation</span>
<span class="fu">ggs_autocorrelation</span><span class="op">(</span><span class="fu">ggs</span><span class="op">(</span><span class="va">fit</span>, family<span class="op">=</span><span class="st">"lambda"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
   <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-stan-3-7.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb243"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggs_autocorrelation</span><span class="op">(</span><span class="fu">ggs</span><span class="op">(</span><span class="va">fit</span>, family<span class="op">=</span><span class="st">"tau"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
   <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-stan-3-8.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb244"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggs_autocorrelation</span><span class="op">(</span><span class="fu">ggs</span><span class="op">(</span><span class="va">fit</span>, family<span class="op">=</span><span class="st">"psi"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
   <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-stan-3-9.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb245"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggs_autocorrelation</span><span class="op">(</span><span class="fu">ggs</span><span class="op">(</span><span class="va">fit</span>, family<span class="op">=</span><span class="st">"phi"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
   <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-stan-3-10.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb246"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># plot the posterior density</span>
<span class="va">plot.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>

<span class="va">plot_title</span> <span class="op">&lt;-</span> <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Posterior distributions"</span>,
                      <span class="st">"with medians and 80% intervals"</span><span class="op">)</span>
<span class="fu">mcmc_areas</span><span class="op">(</span>
  <span class="va">plot.data</span>,
  pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lambda[2]"</span>, <span class="st">"lambda[3]"</span>, <span class="st">"lambda[5]"</span><span class="op">)</span>,
  prob <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span>
  <span class="va">plot_title</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-stan-3-11.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb247"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">mcmc_areas</span><span class="op">(</span>
  <span class="va">plot.data</span>,
  pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"tau["</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="st">"]"</span><span class="op">)</span>,
  prob <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span>
  <span class="va">plot_title</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-stan-3-12.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb248"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">mcmc_areas</span><span class="op">(</span>
  <span class="va">plot.data</span>,
  pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"psi["</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="st">"]"</span><span class="op">)</span>,
           <span class="st">"phi[1,1]"</span>, <span class="st">"phi[1,2]"</span>, <span class="st">"phi[2,2]"</span><span class="op">)</span>,
  prob <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span>
  <span class="va">plot_title</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-stan-3-13.png" width="90%" height="90%"></div>
</div>
</div>
<div id="blavaan---two-latent-variables" class="section level2" number="9.8">
<h2>
<span class="header-section-number">9.8</span> Blavaan - Two Latent Variables<a class="anchor" aria-label="anchor" href="#blavaan---two-latent-variables"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb249"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># model</span>
<span class="va">model_cfa2_blavaan</span> <span class="op">&lt;-</span> <span class="st">"
  f1 =~ 1*PI + AD + IGC 
  f2 =~ 1*FI + FC
  f1 ~~ f2
"</span>

<span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span><span class="op">(</span><span class="st">"code/CFA-Two-Latent-Variables/Data/IIS.dat"</span>, header<span class="op">=</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span>

<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">blavaan</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/blavaan/man/bcfa.html">bcfa</a></span><span class="op">(</span><span class="va">model_cfa2_blavaan</span>, data<span class="op">=</span><span class="va">dat</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## SAMPLING FOR MODEL 'stanmarg' NOW (CHAIN 1).
## Chain 1: 
## Chain 1: Gradient evaluation took 0 seconds
## Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 0 seconds.
## Chain 1: Adjust your expectations accordingly!
## Chain 1: 
## Chain 1: 
## Chain 1: Iteration:    1 / 1500 [  0%]  (Warmup)
## Chain 1: Iteration:  150 / 1500 [ 10%]  (Warmup)
## Chain 1: Iteration:  300 / 1500 [ 20%]  (Warmup)
## Chain 1: Iteration:  450 / 1500 [ 30%]  (Warmup)
## Chain 1: Iteration:  501 / 1500 [ 33%]  (Sampling)
## Chain 1: Iteration:  650 / 1500 [ 43%]  (Sampling)
## Chain 1: Iteration:  800 / 1500 [ 53%]  (Sampling)
## Chain 1: Iteration:  950 / 1500 [ 63%]  (Sampling)
## Chain 1: Iteration: 1100 / 1500 [ 73%]  (Sampling)
## Chain 1: Iteration: 1250 / 1500 [ 83%]  (Sampling)
## Chain 1: Iteration: 1400 / 1500 [ 93%]  (Sampling)
## Chain 1: Iteration: 1500 / 1500 [100%]  (Sampling)
## Chain 1: 
## Chain 1:  Elapsed Time: 3.143 seconds (Warm-up)
## Chain 1:                5.847 seconds (Sampling)
## Chain 1:                8.99 seconds (Total)
## Chain 1: 
## 
## SAMPLING FOR MODEL 'stanmarg' NOW (CHAIN 2).
## Chain 2: 
## Chain 2: Gradient evaluation took 0 seconds
## Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 0 seconds.
## Chain 2: Adjust your expectations accordingly!
## Chain 2: 
## Chain 2: 
## Chain 2: Iteration:    1 / 1500 [  0%]  (Warmup)
## Chain 2: Iteration:  150 / 1500 [ 10%]  (Warmup)
## Chain 2: Iteration:  300 / 1500 [ 20%]  (Warmup)
## Chain 2: Iteration:  450 / 1500 [ 30%]  (Warmup)
## Chain 2: Iteration:  501 / 1500 [ 33%]  (Sampling)
## Chain 2: Iteration:  650 / 1500 [ 43%]  (Sampling)
## Chain 2: Iteration:  800 / 1500 [ 53%]  (Sampling)
## Chain 2: Iteration:  950 / 1500 [ 63%]  (Sampling)
## Chain 2: Iteration: 1100 / 1500 [ 73%]  (Sampling)
## Chain 2: Iteration: 1250 / 1500 [ 83%]  (Sampling)
## Chain 2: Iteration: 1400 / 1500 [ 93%]  (Sampling)
## Chain 2: Iteration: 1500 / 1500 [100%]  (Sampling)
## Chain 2: 
## Chain 2:  Elapsed Time: 3.095 seconds (Warm-up)
## Chain 2:                5.793 seconds (Sampling)
## Chain 2:                8.888 seconds (Total)
## Chain 2: 
## 
## SAMPLING FOR MODEL 'stanmarg' NOW (CHAIN 3).
## Chain 3: 
## Chain 3: Gradient evaluation took 0 seconds
## Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 0 seconds.
## Chain 3: Adjust your expectations accordingly!
## Chain 3: 
## Chain 3: 
## Chain 3: Iteration:    1 / 1500 [  0%]  (Warmup)
## Chain 3: Iteration:  150 / 1500 [ 10%]  (Warmup)
## Chain 3: Iteration:  300 / 1500 [ 20%]  (Warmup)
## Chain 3: Iteration:  450 / 1500 [ 30%]  (Warmup)
## Chain 3: Iteration:  501 / 1500 [ 33%]  (Sampling)
## Chain 3: Iteration:  650 / 1500 [ 43%]  (Sampling)
## Chain 3: Iteration:  800 / 1500 [ 53%]  (Sampling)
## Chain 3: Iteration:  950 / 1500 [ 63%]  (Sampling)
## Chain 3: Iteration: 1100 / 1500 [ 73%]  (Sampling)
## Chain 3: Iteration: 1250 / 1500 [ 83%]  (Sampling)
## Chain 3: Iteration: 1400 / 1500 [ 93%]  (Sampling)
## Chain 3: Iteration: 1500 / 1500 [100%]  (Sampling)
## Chain 3: 
## Chain 3:  Elapsed Time: 3.073 seconds (Warm-up)
## Chain 3:                5.512 seconds (Sampling)
## Chain 3:                8.585 seconds (Total)
## Chain 3: 
## Computing posterior predictives...</code></pre>
<div class="sourceCode" id="cb251"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></code></pre></div>
<pre><code>## blavaan (0.4-3) results of 1000 samples after 500 adapt/burnin iterations
## 
##   Number of observations                           500
## 
##   Number of missing patterns                         1
## 
##   Statistic                                 MargLogLik         PPP
##   Value                                      -2174.153       0.000
## 
## Latent Variables:
##                    Estimate  Post.SD pi.lower pi.upper     Rhat    Prior       
##   f1 =~                                                                        
##     PI                1.000                                                    
##     AD                0.955    0.068    0.833    1.095    1.001    normal(0,10)
##     IGC               0.561    0.045    0.477    0.657    1.001    normal(0,10)
##   f2 =~                                                                        
##     FI                1.000                                                    
##     FC                1.006    0.062    0.894    1.140    1.000    normal(0,10)
## 
## Covariances:
##                    Estimate  Post.SD pi.lower pi.upper     Rhat    Prior       
##   f1 ~~                                                                        
##     f2                0.313    0.034    0.250    0.383    1.002     lkj_corr(1)
## 
## Intercepts:
##                    Estimate  Post.SD pi.lower pi.upper     Rhat    Prior       
##    .PI                3.333    0.037    3.260    3.410    0.999    normal(0,32)
##    .AD                3.898    0.027    3.846    3.952    1.000    normal(0,32)
##    .IGC               4.596    0.021    4.556    4.636    1.000    normal(0,32)
##    .FI                3.033    0.039    2.956    3.110    0.999    normal(0,32)
##    .FC                3.712    0.036    3.645    3.782    1.000    normal(0,32)
##     f1                0.000                                                    
##     f2                0.000                                                    
## 
## Variances:
##                    Estimate  Post.SD pi.lower pi.upper     Rhat    Prior       
##    .PI                0.381    0.030    0.326    0.442    1.000 gamma(1,.5)[sd]
##    .AD                0.077    0.013    0.052    0.103    1.000 gamma(1,.5)[sd]
##    .IGC               0.117    0.009    0.101    0.134    1.000 gamma(1,.5)[sd]
##    .FI                0.322    0.030    0.265    0.383    1.000 gamma(1,.5)[sd]
##    .FC                0.152    0.024    0.105    0.199    0.999 gamma(1,.5)[sd]
##     f1                0.312    0.039    0.237    0.394    1.002 gamma(1,.5)[sd]
##     f2                0.467    0.051    0.369    0.570    1.000 gamma(1,.5)[sd]</code></pre>
<div class="sourceCode" id="cb253"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-blavaan-2-1.png" width="90%" height="90%"></div>
</div>
<div id="indeterminacy-in-one-factor-cfa" class="section level2" number="9.9">
<h2>
<span class="header-section-number">9.9</span> Indeterminacy in One Factor CFA<a class="anchor" aria-label="anchor" href="#indeterminacy-in-one-factor-cfa"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb254"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># model code</span>
<span class="va">jags.model.cfa.ind</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span>

  <span class="co">######################################################################</span>
  <span class="co"># Specify the factor analysis measurement model for the observables</span>
  <span class="co">######################################################################</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span><span class="op">{</span>
    <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">J</span><span class="op">)</span><span class="op">{</span>
      <span class="va">mu</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">tau</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">+</span> <span class="va">ksi</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">*</span><span class="va">lambda</span><span class="op">[</span><span class="va">j</span><span class="op">]</span>      <span class="co"># model implied expectation for each observable</span>
      <span class="va">x</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">mu</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span><span class="op">]</span>, <span class="va">inv.psi</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span>    <span class="co"># distribution for each observable</span>
    <span class="op">}</span>
  <span class="op">}</span>
  
  
  <span class="co">######################################################################</span>
  <span class="co"># Specify the (prior) distribution for the latent variables</span>
  <span class="co">######################################################################</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span><span class="op">{</span>
    <span class="va">ksi</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">kappa</span>, <span class="va">inv.phi</span><span class="op">)</span>  <span class="co"># distribution for the latent variables</span>
  <span class="op">}</span>
  
  
  <span class="co">######################################################################</span>
  <span class="co"># Specify the prior distribution for the parameters that govern the latent variables</span>
  <span class="co">######################################################################</span>
  <span class="va">kappa</span> <span class="op">&lt;-</span> <span class="fl">0</span>              <span class="co"># Mean of factor 1</span>
  <span class="va">inv.phi</span> <span class="op">&lt;-</span><span class="fl">1</span>   <span class="co"># Precision of factor 1</span>
  <span class="va">phi</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="va">inv.phi</span>        <span class="co"># Variance of factor 1</span>
  
  
  <span class="co">######################################################################</span>
  <span class="co"># Specify the prior distribution for the measurement model parameters</span>
  <span class="co">######################################################################</span>
  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">J</span><span class="op">)</span><span class="op">{</span>
    <span class="va">tau</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">.1</span><span class="op">)</span>        <span class="co"># Intercepts for observables</span>
    <span class="va">inv.psi</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html">dgamma</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span> <span class="co"># Precisions for observables</span>
    <span class="va">psi</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="va">inv.psi</span><span class="op">[</span><span class="va">j</span><span class="op">]</span>   <span class="co"># Variances for observables</span>
  <span class="op">}</span>
  
  <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">J</span><span class="op">)</span><span class="op">{</span>
    <span class="va">lambda</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">.1</span><span class="op">)</span>    <span class="co"># prior distribution for the remaining loadings</span>
  <span class="op">}</span>
<span class="op">}</span>
<span class="co"># data must be in a list</span>
<span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span><span class="op">(</span><span class="st">"code/CFA-One-Latent-Variable/Data/IIS.dat"</span>, header<span class="op">=</span><span class="cn">T</span><span class="op">)</span>

<span class="va">mydata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  n <span class="op">=</span> <span class="fl">500</span>, J <span class="op">=</span> <span class="fl">5</span>,
  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span>
<span class="op">)</span>


<span class="co"># initial values</span>
<span class="va">start_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"tau"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3.00E+00</span>, <span class="fl">3.00E+00</span>, <span class="fl">3.00E+00</span>, <span class="fl">3.00E+00</span>, <span class="fl">3.00E+00</span><span class="op">)</span>,
       <span class="st">"lambda"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3.00E+00</span>, <span class="fl">3.00E+00</span>, <span class="fl">3.00E+00</span>, <span class="fl">3.00E+00</span>, <span class="fl">3.00E+00</span><span class="op">)</span>,
       <span class="st">"inv.psi"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2.00E+00</span>, <span class="fl">2.00E+00</span>, <span class="fl">2.00E+00</span>, <span class="fl">2.00E+00</span>, <span class="fl">2.00E+00</span><span class="op">)</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"tau"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3.00E+00</span>, <span class="fl">3.00E+00</span>, <span class="fl">3.00E+00</span>, <span class="fl">3.00E+00</span>, <span class="fl">3.00E+00</span><span class="op">)</span>,
       <span class="st">"lambda"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3.00E+00</span>, <span class="op">-</span><span class="fl">3.00E+00</span>, <span class="op">-</span><span class="fl">3.00E+00</span>, <span class="op">-</span><span class="fl">3.00E+00</span>, <span class="op">-</span><span class="fl">3.00E+00</span><span class="op">)</span>,
       <span class="st">"inv.psi"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2.00E+00</span>, <span class="fl">2.00E+00</span>, <span class="fl">2.00E+00</span>, <span class="fl">2.00E+00</span>, <span class="fl">2.00E+00</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># vector of all parameters to save</span>
<span class="co"># exclude fixed lambda since it throws an error in</span>
<span class="co"># in the GRB plot</span>
<span class="va">param_save</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"tau[1]"</span>, <span class="st">"lambda[1]"</span>, <span class="st">"phi"</span>, <span class="st">"psi[1]"</span>, <span class="st">"ksi[8]"</span><span class="op">)</span>

<span class="co"># fit model</span>
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">jags</span><span class="op">(</span>
  model.file<span class="op">=</span><span class="va">jags.model.cfa.ind</span>,
  data<span class="op">=</span><span class="va">mydata</span>,
  inits<span class="op">=</span><span class="va">start_values</span>,
  parameters.to.save <span class="op">=</span> <span class="va">param_save</span>,
  n.iter<span class="op">=</span><span class="fl">5000</span>,
  n.burnin <span class="op">=</span> <span class="fl">2500</span>,
  n.chains <span class="op">=</span> <span class="fl">2</span>,
  n.thin<span class="op">=</span><span class="fl">1</span>,
  progress.bar <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></code></pre></div>
<pre><code>## Compiling model graph
##    Resolving undeclared variables
##    Allocating nodes
## Graph information:
##    Observed stochastic nodes: 2500
##    Unobserved stochastic nodes: 515
##    Total graph size: 8029
## 
## Initializing model</code></pre>
<div class="sourceCode" id="cb256"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></code></pre></div>
<pre><code>## Inference for Bugs model at "C:/Users/noahp/AppData/Local/Temp/RtmpaGlb2m/model324430075f3.txt", fit using jags,
##  2 chains, each with 5000 iterations (first 2500 discarded)
##  n.sims = 5000 iterations saved
##            mu.vect sd.vect     2.5%      25%      50%      75%    97.5%   Rhat n.eff
## ksi[8]      -0.005   1.397   -2.018   -1.336   -0.087    1.332    1.985  8.258     2
## lambda[1]    0.001   0.598   -0.652   -0.591    0.012    0.592    0.651 21.976     2
## phi          1.000   0.000    1.000    1.000    1.000    1.000    1.000  1.000     1
## psi[1]       0.381   0.029    0.327    0.361    0.380    0.400    0.440  1.003   590
## tau[1]       3.332   0.038    3.258    3.307    3.333    3.359    3.405  1.001  2300
## deviance  3383.561  60.868 3300.788 3354.174 3382.183 3410.957 3467.656  1.001  2900
## 
## For each parameter, n.eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor (at convergence, Rhat=1).
## 
## DIC info (using the rule, pD = var(deviance)/2)
## pD = 1852.3 and DIC = 5235.9
## DIC is an estimate of expected predictive error (lower deviance is better).</code></pre>
<div class="sourceCode" id="cb258"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># extract posteriors for all chains</span>
<span class="va">jags.mcmc</span> <span class="op">&lt;-</span> <span class="fu">as.mcmc</span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>

<span class="fu">R2jags</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/R2jags/man/traceplot.html">traceplot</a></span><span class="op">(</span><span class="va">jags.mcmc</span><span class="op">)</span></code></pre></div>
<p><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-FID-1.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-FID-2.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-FID-3.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-FID-4.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-FID-5.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp9-cfa-fit-jags-FID-6.png" width="90%" height="90%"></p>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="classical-test-theory.html"><span class="header-section-number">8</span> Classical Test Theory</a></div>
<div class="next"><a href="model-evaluation.html"><span class="header-section-number">10</span> Model Evaluation</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#confirmatory-factor-analysis"><span class="header-section-number">9</span> Confirmatory Factor Analysis</a></li>
<li><a class="nav-link" href="#single-latent-variable-model"><span class="header-section-number">9.1</span> Single Latent Variable Model</a></li>
<li><a class="nav-link" href="#jags---single-latent-variable"><span class="header-section-number">9.2</span> JAGS - Single Latent Variable</a></li>
<li><a class="nav-link" href="#stan---single-latent-variable"><span class="header-section-number">9.3</span> Stan - Single Latent Variable</a></li>
<li><a class="nav-link" href="#blavaan---single-latent-variable"><span class="header-section-number">9.4</span> Blavaan - Single Latent Variable</a></li>
<li><a class="nav-link" href="#two-latent-variable-model"><span class="header-section-number">9.5</span> Two Latent Variable Model</a></li>
<li><a class="nav-link" href="#jags---two-latent-variable"><span class="header-section-number">9.6</span> JAGS - Two Latent Variable</a></li>
<li>
<a class="nav-link" href="#stan---two-latent-variable"><span class="header-section-number">9.7</span> Stan - Two Latent Variable</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#inverse-wishart-prior"><span class="header-section-number">9.7.1</span> Inverse-Wishart Prior</a></li>
<li><a class="nav-link" href="#lkj-cholesky-parameterization"><span class="header-section-number">9.7.2</span> LKJ Cholesky Parameterization</a></li>
</ul>
</li>
<li><a class="nav-link" href="#blavaan---two-latent-variables"><span class="header-section-number">9.8</span> Blavaan - Two Latent Variables</a></li>
<li><a class="nav-link" href="#indeterminacy-in-one-factor-cfa"><span class="header-section-number">9.9</span> Indeterminacy in One Factor CFA</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/noah-padgett/Bayesian-Psychometric-Modeling/blob/master/09-cfa.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/noah-padgett/Bayesian-Psychometric-Modeling/edit/master/09-cfa.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Bayesian Psychometric Modeling (2016) by Roy Levy and Robert J. Mislevy</strong>" was written by R. Noah Padgett. It was last built on 2022-07-15.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
