<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 8 Classical Test Theory | Bayesian Psychometric Modeling (2016) by Roy Levy and Robert J. Mislevy</title>
<meta name="author" content="R. Noah Padgett">
<meta name="description" content="The traditional model specification for CTT is \[X = T + E,\] where \(X\) is the observed test/measure score, \(T\) is the truce score we wish to make inferences about, and \(E\) is the error. The...">
<meta name="generator" content="bookdown 0.26 with bs4_book()">
<meta property="og:title" content="Chapter 8 Classical Test Theory | Bayesian Psychometric Modeling (2016) by Roy Levy and Robert J. Mislevy">
<meta property="og:type" content="book">
<meta property="og:description" content="The traditional model specification for CTT is \[X = T + E,\] where \(X\) is the observed test/measure score, \(T\) is the truce score we wish to make inferences about, and \(E\) is the error. The...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 8 Classical Test Theory | Bayesian Psychometric Modeling (2016) by Roy Levy and Robert J. Mislevy">
<meta name="twitter:description" content="The traditional model specification for CTT is \[X = T + E,\] where \(X\) is the observed test/measure score, \(T\) is the truce score we wish to make inferences about, and \(E\) is the error. The...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Bayesian Psychometric Modeling (2016) by Roy Levy and Robert J. Mislevy</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li class="book-part">Foundations</li>
<li><a class="" href="overview.html"><span class="header-section-number">1</span> Overview</a></li>
<li><a class="" href="chp2.html"><span class="header-section-number">2</span> Introduction to Bayesian Inference</a></li>
<li><a class="" href="conceptual-issues-in-bayesian-inference.html"><span class="header-section-number">3</span> Conceptual Issues in Bayesian Inference</a></li>
<li><a class="" href="normal-distribution-models.html"><span class="header-section-number">4</span> Normal Distribution Models</a></li>
<li><a class="" href="markov-chain-monte-carlo-estimation.html"><span class="header-section-number">5</span> Markov Chain Monte Carlo Estimation</a></li>
<li><a class="" href="regression.html"><span class="header-section-number">6</span> Regression</a></li>
<li class="book-part">Psychometrics</li>
<li><a class="" href="canonical-bayesian-psychometric-modeling.html"><span class="header-section-number">7</span> Canonical Bayesian Psychometric Modeling</a></li>
<li><a class="active" href="classical-test-theory.html"><span class="header-section-number">8</span> Classical Test Theory</a></li>
<li><a class="" href="confirmatory-factor-analysis.html"><span class="header-section-number">9</span> Confirmatory Factor Analysis</a></li>
<li><a class="" href="model-evaluation.html"><span class="header-section-number">10</span> Model Evaluation</a></li>
<li><a class="" href="item-response-theory.html"><span class="header-section-number">11</span> Item Response Theory</a></li>
<li><a class="" href="missing-data-modeling.html"><span class="header-section-number">12</span> Missing Data Modeling</a></li>
<li><a class="" href="latent-class-analysis.html"><span class="header-section-number">13</span> Latent Class Analysis</a></li>
<li><a class="" href="bayesian-networks.html"><span class="header-section-number">14</span> Bayesian Networks</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/noah-padgett/Bayesian-Psychometric-Modeling">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="classical-test-theory" class="section level1" number="8">
<h1>
<span class="header-section-number">8</span> Classical Test Theory<a class="anchor" aria-label="anchor" href="#classical-test-theory"><i class="fas fa-link"></i></a>
</h1>
<p>The traditional model specification for CTT is
<span class="math display">\[X = T + E,\]</span>
where <span class="math inline">\(X\)</span> is the observed test/measure score, <span class="math inline">\(T\)</span> is the truce score we wish to make inferences about, and <span class="math inline">\(E\)</span> is the error.
The true scores have population mean <span class="math inline">\(\mu_T\)</span> and variance <span class="math inline">\(\sigma^2_T\)</span>.
The errors for any individual are expected to be 0 on average, <span class="math inline">\(\mathbb{E}(E_i)=0\)</span> with variance <span class="math inline">\(\sigma^2_E\)</span>.
The errors are <em>uncorrelated</em> with the true score in the population, that is
<span class="math display">\[\mathbb{COV}(T, E) = \sigma_{TE} = \rho_{TE}\sigma_{T}\sigma_E = 0.\]</span></p>
<p>Some implications associated with the CTT model are:</p>
<ol style="list-style-type: decimal">
<li><p>The population mean of observed scores is the same as the true scores
<span class="math display">\[\mu_x = \mu_T.\]</span></p></li>
<li><p>The observed score variance can be decomposed into
<span class="math display">\[\begin{align*}
\sigma^2_X &amp;= \sigma^2_T + \sigma^2_E + 2\sigma_{TE}\\
&amp;= \sigma^2_T + \sigma^2_E.
\end{align*}\]</span></p></li>
<li><p>We can define the <em>reliability</em> in terms of the ratio of true score variance to observed score variance, that is
<span class="math display">\[\rho = \frac{\sigma^2_T}{\sigma^2_X}  = \frac{\sigma^2_T}{\sigma^2_T + \sigma^2_E}.\]</span></p></li>
</ol>
<p>An interesting approach to deriving estimates of true scores is to flip the traditional CTT model around so that we define the true score as a function of the observed score.
This uses Kelley’s formula <span class="citation">(<a href="references.html#ref-Kelley1923" role="doc-biblioref">Kelley 1923</a>)</span>,
<span class="math display">\[\begin{align*}
\hat{T}_i &amp;= \rho x_i + (1-\rho)\mu_x\\
&amp;= \mu_x + \rho (x_i - \mu_x),
\end{align*}\]</span>
where <span class="math inline">\(\mu_x\)</span> is the mean of the observed scores and <span class="math inline">\(\hat{T}_i\)</span> is the estimated true score of individual <span class="math inline">\(i\)</span>.
This is an interesting formula since there’s the notion about how to incorporate uncertainty into the estimation of the true score.
The higher the uncertainty (lower the reliability) the less we weight the observed score and more we rely on the population mean as our estimate.</p>
<p>This has a very Bayesian feel to is, because it’s nearly identical to how we derive the posterior mean in a conjugate normal model (see p.158).</p>
<div id="example-1---known-measurement-model-parameters-with-1-measure" class="section level2" number="8.1">
<h2>
<span class="header-section-number">8.1</span> Example 1 - Known measurement model parameters with 1 measure<a class="anchor" aria-label="anchor" href="#example-1---known-measurement-model-parameters-with-1-measure"><i class="fas fa-link"></i></a>
</h2>
<p>Here, we will discuss a simple CTT example where we assume that the measurement model parameters are known.
This means we assume a value for <span class="math inline">\(\mu_t\)</span>, <span class="math inline">\(\sigma^2_T\)</span>, and <span class="math inline">\(\sigma^2_E\)</span>.
We would nearly always need to estimate these quantities to provide an informed decision as to what these parameters should be.</p>
<p>This example using 3 observations (individuals) with 1 measure per individual.
The DAG for this model is shown below.</p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:chp8-dag-1"></span>
<img src="dag/chp8-ctt1.png" alt="Simple CTT model with 1 measure and known measurement parameters" width="90%" height="90%"><p class="caption">
Figure 8.1: Simple CTT model with 1 measure and known measurement parameters
</p>
</div>
<p>With a simply model specification using normal distributions as the underly probability functions.</p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:chp8-spec-1"></span>
<img src="model-spec/chp8-ctt1.png" alt="Model specification diagram for the known parameters CTT model" width="90%" height="90%"><p class="caption">
Figure 8.2: Model specification diagram for the known parameters CTT model
</p>
</div>
</div>
<div id="example-1---stan" class="section level2" number="8.2">
<h2>
<span class="header-section-number">8.2</span> Example 1 - Stan<a class="anchor" aria-label="anchor" href="#example-1---stan"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model_ctt1</span> <span class="op">&lt;-</span> <span class="st">'
data {
  int  N;
  real x[N];
  real muT;
  real sigmaT;
  real sigmaE;
}

parameters {
  real T[N];
}

model {
  for(i in 1:N){
    x[i] ~ normal(T[i], sigmaE);
    T[i] ~ normal(muT, sigmaT);
  }
}

'</span>
<span class="co"># data must be in a list</span>
<span class="va">mydata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  N<span class="op">=</span><span class="fl">3</span>, 
  x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">70</span>, <span class="fl">80</span>, <span class="fl">96</span><span class="op">)</span>,
  muT <span class="op">=</span> <span class="fl">80</span>,
  sigmaT <span class="op">=</span> <span class="fl">6</span>, <span class="co">#sqrt(36)</span>
  sigmaE <span class="op">=</span> <span class="fl">4</span> <span class="co"># sqrt(16)</span>
<span class="op">)</span>

<span class="co"># Next, need to fit the model</span>
<span class="co">#   I have explicitly outlined some common parameters</span>
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">stan</span><span class="op">(</span>
  model_code <span class="op">=</span> <span class="va">model_ctt1</span>, <span class="co"># model code to be compiled</span>
  data <span class="op">=</span> <span class="va">mydata</span>,          <span class="co"># my data</span>
  chains <span class="op">=</span> <span class="fl">4</span>,             <span class="co"># number of Markov chains</span>
  warmup <span class="op">=</span> <span class="fl">1000</span>,          <span class="co"># number of warm up iterations per chain</span>
  iter <span class="op">=</span> <span class="fl">5000</span>,            <span class="co"># total number of iterations per chain</span>
  cores <span class="op">=</span> <span class="fl">4</span>,              <span class="co"># number of cores (could use one per chain)</span>
  refresh <span class="op">=</span> <span class="fl">0</span>             <span class="co"># no progress shown</span>
<span class="op">)</span>

<span class="co"># first get a basic breakdown of the posteriors</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></code></pre></div>
<pre><code>## Inference for Stan model: anon_model.
## 4 chains, each with iter=5000; warmup=1000; thin=1; 
## post-warmup draws per chain=4000, total post-warmup draws=16000.
## 
##       mean se_mean   sd  2.5%   25%   50%   75% 97.5% n_eff Rhat
## T[1] 73.13    0.02 3.31 66.66 70.88 73.12 75.36 79.66 18495    1
## T[2] 79.94    0.02 3.33 73.45 77.70 79.94 82.17 86.48 18747    1
## T[3] 91.10    0.03 3.33 84.61 88.81 91.10 93.36 97.74 15136    1
## lp__ -4.92    0.01 1.23 -8.14 -5.46 -4.61 -4.03 -3.53  8272    1
## 
## Samples were drawn using NUTS(diag_e) at Sun Jun 19 17:32:47 2022.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># plot the posterior in a</span>
<span class="co">#  95% probability interval</span>
<span class="co">#  and 80% to contrast the dispersion</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></code></pre></div>
<pre><code>## ci_level: 0.8 (80% intervals)</code></pre>
<pre><code>## outer_level: 0.95 (95% intervals)</code></pre>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-stan-1-1.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># traceplots</span>
<span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-traceplot.html">traceplot</a></span><span class="op">(</span><span class="va">fit</span>, pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"T"</span><span class="op">)</span>, inc_warmup <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-stan-1-2.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Gelman-Rubin-Brooks Convergence Criterion</span>
<span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">ggs_grb</span><span class="op">(</span><span class="fu">ggs</span><span class="op">(</span><span class="va">fit</span>, family <span class="op">=</span> <span class="st">"T"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
   <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">p1</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-stan-1-3.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># autocorrelation</span>
<span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">ggs_autocorrelation</span><span class="op">(</span><span class="fu">ggs</span><span class="op">(</span><span class="va">fit</span>, family<span class="op">=</span><span class="st">"T"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
   <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">p1</span> </code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-stan-1-4.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># plot the posterior density</span>
<span class="va">plot.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>

<span class="va">plot_title</span> <span class="op">&lt;-</span> <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Posterior distributions"</span>,
                      <span class="st">"with medians and 80% intervals"</span><span class="op">)</span>
<span class="fu">mcmc_areas</span><span class="op">(</span>
  <span class="va">plot.data</span>,
  pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"T[1]"</span>,<span class="st">"T[2]"</span>,<span class="st">"T[3]"</span><span class="op">)</span>,
  prob <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span> 
  <span class="va">plot_title</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-stan-1-5.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># I prefer a posterior plot that includes prior and MLE</span>
<span class="co"># Expanded Posterior Plot</span>
<span class="va">MLE</span> <span class="op">&lt;-</span> <span class="va">mydata</span><span class="op">$</span><span class="va">x</span>
<span class="va">prior_t</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">80</span>, <span class="fl">6</span><span class="op">)</span><span class="op">}</span>
<span class="va">x.t</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">50.1</span>, <span class="fl">100</span>, <span class="fl">0.1</span><span class="op">)</span>
<span class="va">prior.t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>tr<span class="op">=</span><span class="va">x.t</span>, dens.t <span class="op">=</span> <span class="fu">prior_t</span><span class="op">(</span><span class="va">x.t</span><span class="op">)</span><span class="op">)</span>
<span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Posterior"</span><span class="op">=</span><span class="st">"#0072B2"</span>, <span class="st">"Prior"</span><span class="op">=</span><span class="st">"#E69F00"</span>, <span class="st">"MLE"</span><span class="op">=</span> <span class="st">"black"</span><span class="op">)</span><span class="co">#"#56B4E9", "#E69F00" "#CC79A7"</span>
<span class="va">plot.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">plot.data</span><span class="op">)</span>
<span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">plot.data</span>,
               <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">`T[1]`</span>, color<span class="op">=</span><span class="st">"Posterior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span>data<span class="op">=</span><span class="va">prior.t</span>,
            <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">tr</span>, y<span class="op">=</span><span class="va">dens.t</span>, color<span class="op">=</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept<span class="op">=</span><span class="va">MLE</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, color<span class="op">=</span><span class="st">"MLE"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">cols</span>, name<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">plot.data</span>,
               <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">`T[2]`</span>, color<span class="op">=</span><span class="st">"Posterior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span>data<span class="op">=</span><span class="va">prior.t</span>,
            <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">tr</span>, y<span class="op">=</span><span class="va">dens.t</span>, color<span class="op">=</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept<span class="op">=</span><span class="va">MLE</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, color<span class="op">=</span><span class="st">"MLE"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">cols</span>, name<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">plot.data</span>,
               <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">`T[3]`</span>, color<span class="op">=</span><span class="st">"Posterior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span>data<span class="op">=</span><span class="va">prior.t</span>,
            <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">tr</span>, y<span class="op">=</span><span class="va">dens.t</span>, color<span class="op">=</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept<span class="op">=</span><span class="va">MLE</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, color<span class="op">=</span><span class="st">"MLE"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">cols</span>, name<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span> <span class="op">+</span> <span class="va">p3</span> <span class="op">+</span> <span class="fu">plot_layout</span><span class="op">(</span>guides<span class="op">=</span><span class="st">"collect"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-stan-1-6.png" width="90%" height="90%"></div>
</div>
<div id="example-1---jags" class="section level2" number="8.3">
<h2>
<span class="header-section-number">8.3</span> Example 1 - JAGS<a class="anchor" aria-label="anchor" href="#example-1---jags"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb93"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># model code</span>
<span class="va">jags.model.ctt1</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span>
   <span class="co">############################################</span>
     <span class="co"># CLASSICAL TEST THEORY MODEL</span>
     <span class="co"># WITH KNOWN HYPERPARAMETERS</span>
     <span class="co">#    TRUE SCORE MEAN, TRUE SCORE VARIANCE</span>
     <span class="co">#    ERROR VARIANCE</span>
     <span class="co">############################################</span>

     <span class="co">############################################</span>
     <span class="co"># KNOWN HYPERPARAMETERS</span>
     <span class="co">############################################</span>
     <span class="va">mu.T</span> <span class="op">&lt;-</span> <span class="fl">80</span>               <span class="co"># Mean of the true scores</span>
     <span class="va">sigma.squared.T</span> <span class="op">&lt;-</span> <span class="fl">36</span>    <span class="co"># Variance of the true scores</span>
     <span class="va">sigma.squared.E</span> <span class="op">&lt;-</span> <span class="fl">16</span>    <span class="co"># Variance of the errors</span>

     <span class="va">tau.T</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="va">sigma.squared.T</span>   <span class="co"># Precision of the true scores</span>
     <span class="va">tau.E</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="va">sigma.squared.E</span>   <span class="co"># Precision of the errors</span>

 
     <span class="co">############################################</span>
     <span class="co"># MODEL FOR TRUE SCORES AND OBSERVABLES</span>
     <span class="co">############################################</span>
 
     <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span>
          <span class="cn">T</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">mu.T</span>, <span class="va">tau.T</span><span class="op">)</span>     <span class="co"># Distribution of true scores</span>
          <span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="cn">T</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">tau.E</span><span class="op">)</span>     <span class="co"># Distribution of observables</span>
     <span class="op">}</span>
    
<span class="op">}</span>
<span class="co"># data</span>
<span class="va">mydata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  n<span class="op">=</span><span class="fl">3</span>, 
  x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">70</span>, <span class="fl">80</span>, <span class="fl">96</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># starting values</span>
<span class="va">start_values</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"T"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">80</span>,<span class="fl">80</span>,<span class="fl">80</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># vector of all parameters to save</span>
<span class="va">param_save</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"T"</span><span class="op">)</span>

<span class="co"># fit model</span>
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">jags</span><span class="op">(</span>
  model.file<span class="op">=</span><span class="va">jags.model.ctt1</span>,
  data<span class="op">=</span><span class="va">mydata</span>,
  inits<span class="op">=</span><span class="va">start_values</span>,
  parameters.to.save <span class="op">=</span> <span class="va">param_save</span>,
  n.iter<span class="op">=</span><span class="fl">4000</span>,
  n.burnin <span class="op">=</span> <span class="fl">1000</span>,
  n.chains <span class="op">=</span> <span class="fl">4</span>,
  n.thin<span class="op">=</span><span class="fl">1</span>,
  progress.bar <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></code></pre></div>
<pre><code>## Compiling model graph
##    Resolving undeclared variables
##    Allocating nodes
## Graph information:
##    Observed stochastic nodes: 3
##    Unobserved stochastic nodes: 3
##    Total graph size: 13
## 
## Initializing model</code></pre>
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></code></pre></div>
<pre><code>## Inference for Bugs model at "C:/Users/noahp/AppData/Local/Temp/RtmpQR8sbs/model4544520665bc.txt", fit using jags,
##  4 chains, each with 4000 iterations (first 1000 discarded)
##  n.sims = 12000 iterations saved
##          mu.vect sd.vect   2.5%    25%    50%    75%  97.5%  Rhat n.eff
## T[1]      73.086   3.292 66.649 70.841 73.088 75.308 79.526 1.001  7300
## T[2]      80.064   3.272 73.653 77.859 80.065 82.292 86.524 1.001  5500
## T[3]      91.045   3.341 84.470 88.763 91.061 93.306 97.453 1.001 12000
## deviance  18.005   2.932 14.208 15.784 17.399 19.551 25.289 1.001 12000
## 
## For each parameter, n.eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor (at convergence, Rhat=1).
## 
## DIC info (using the rule, pD = var(deviance)/2)
## pD = 4.3 and DIC = 22.3
## DIC is an estimate of expected predictive error (lower deviance is better).</code></pre>
<div class="sourceCode" id="cb97"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># extract posteriors for all chains</span>
<span class="va">jags.mcmc</span> <span class="op">&lt;-</span> <span class="fu">as.mcmc</span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>

<span class="fu">R2jags</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/R2jags/man/traceplot.html">traceplot</a></span><span class="op">(</span><span class="va">jags.mcmc</span><span class="op">)</span></code></pre></div>
<p><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-jags-1-1.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-jags-1-2.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-jags-1-3.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-jags-1-4.png" width="90%" height="90%"></p>
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># gelman-rubin-brook</span>
<span class="fu">gelman.plot</span><span class="op">(</span><span class="va">jags.mcmc</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-jags-1-5.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb99"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># convert to single data.frame for density plot</span>
<span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">jags.mcmc</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
<span class="va">plot.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">jags.mcmc</span>, chains<span class="op">=</span><span class="cn">T</span>, iters <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">plot.data</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"chain"</span>, <span class="st">"iter"</span>, <span class="va">a</span><span class="op">)</span>


<span class="va">plot_title</span> <span class="op">&lt;-</span> <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Posterior distributions"</span>,
                      <span class="st">"with medians and 80% intervals"</span><span class="op">)</span>
<span class="fu">mcmc_areas</span><span class="op">(</span>
  <span class="va">plot.data</span>,
  pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"T[1]"</span>, <span class="st">"T[2]"</span>, <span class="st">"T[3]"</span><span class="op">)</span>,
  prob <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span> 
  <span class="va">plot_title</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-jags-1-6.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb100"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># I prefer a posterior plot that includes prior and MLE</span>
<span class="va">MLE</span> <span class="op">&lt;-</span> <span class="va">mydata</span><span class="op">$</span><span class="va">x</span>
<span class="va">prior_t</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">80</span>, <span class="fl">6</span><span class="op">)</span><span class="op">}</span>
<span class="va">x.t</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">50.1</span>, <span class="fl">100</span>, <span class="fl">0.1</span><span class="op">)</span>
<span class="va">prior.t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>tr<span class="op">=</span><span class="va">x.t</span>, dens.t <span class="op">=</span> <span class="fu">prior_t</span><span class="op">(</span><span class="va">x.t</span><span class="op">)</span><span class="op">)</span>
<span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Posterior"</span><span class="op">=</span><span class="st">"#0072B2"</span>, <span class="st">"Prior"</span><span class="op">=</span><span class="st">"#E69F00"</span>, <span class="st">"MLE"</span><span class="op">=</span> <span class="st">"black"</span><span class="op">)</span><span class="co">#"#56B4E9", "#E69F00" "#CC79A7"</span>

<span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">plot.data</span>,
               <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">`T[1]`</span>, color<span class="op">=</span><span class="st">"Posterior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span>data<span class="op">=</span><span class="va">prior.t</span>,
            <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">tr</span>, y<span class="op">=</span><span class="va">dens.t</span>, color<span class="op">=</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept<span class="op">=</span><span class="va">MLE</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, color<span class="op">=</span><span class="st">"MLE"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">cols</span>, name<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">plot.data</span>,
               <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">`T[2]`</span>, color<span class="op">=</span><span class="st">"Posterior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span>data<span class="op">=</span><span class="va">prior.t</span>,
            <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">tr</span>, y<span class="op">=</span><span class="va">dens.t</span>, color<span class="op">=</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept<span class="op">=</span><span class="va">MLE</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, color<span class="op">=</span><span class="st">"MLE"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">cols</span>, name<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">plot.data</span>,
               <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">`T[3]`</span>, color<span class="op">=</span><span class="st">"Posterior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span>data<span class="op">=</span><span class="va">prior.t</span>,
            <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">tr</span>, y<span class="op">=</span><span class="va">dens.t</span>, color<span class="op">=</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept<span class="op">=</span><span class="va">MLE</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, color<span class="op">=</span><span class="st">"MLE"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">cols</span>, name<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span> <span class="op">+</span> <span class="va">p3</span> <span class="op">+</span> <span class="fu">plot_layout</span><span class="op">(</span>guides<span class="op">=</span><span class="st">"collect"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-jags-1-7.png" width="90%" height="90%"></div>
</div>
<div id="example-2---known-measurement-model-with-multiple-measures" class="section level2" number="8.4">
<h2>
<span class="header-section-number">8.4</span> Example 2 - Known Measurement Model with Multiple Measures<a class="anchor" aria-label="anchor" href="#example-2---known-measurement-model-with-multiple-measures"><i class="fas fa-link"></i></a>
</h2>
<p>Here, the only thing that changes from the first example is that now we have multiple observations per individual.
We can think of this as if we could administer a test (or parallel tests) repeatedly without learning occuring.
The DAG and model-specification change to:</p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:chp8-dag-2"></span>
<img src="dag/chp8-ctt2.png" alt="Simple CTT model with known measurement parameters and multiple measures" width="90%" height="90%"><p class="caption">
Figure 8.3: Simple CTT model with known measurement parameters and multiple measures
</p>
</div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:chp8-spec-2"></span>
<img src="model-spec/chp8-ctt2.png" alt="Model specification diagram for the known parameters CTT model and multiple measures" width="90%" height="90%"><p class="caption">
Figure 8.4: Model specification diagram for the known parameters CTT model and multiple measures
</p>
</div>
</div>
<div id="example-2---stan" class="section level2" number="8.5">
<h2>
<span class="header-section-number">8.5</span> Example 2 - Stan<a class="anchor" aria-label="anchor" href="#example-2---stan"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb101"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model_ctt2</span> <span class="op">&lt;-</span> <span class="st">'
data {
  int  N;
  int  J;
  matrix[N, J] X;
  real muT;
  real sigmaT;
  real sigmaE;
}

parameters {
  real T[N];
}

model {
  for(i in 1:N){
    T[i] ~ normal(muT, sigmaT);
    for(j in 1:J){
      X[i, j] ~ normal(T[i], sigmaE);
    }
  }
}

'</span>
<span class="co"># data must be in a list</span>
<span class="va">mydata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  N <span class="op">=</span> <span class="fl">10</span>, J <span class="op">=</span> <span class="fl">5</span>, 
  X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">80</span>, <span class="fl">77</span>, <span class="fl">80</span>, <span class="fl">73</span>, <span class="fl">73</span>,
      <span class="fl">83</span>, <span class="fl">79</span>, <span class="fl">78</span>, <span class="fl">78</span>, <span class="fl">77</span>,
      <span class="fl">85</span>, <span class="fl">77</span>, <span class="fl">88</span>, <span class="fl">81</span>, <span class="fl">80</span>,
      <span class="fl">76</span>, <span class="fl">76</span>, <span class="fl">76</span>, <span class="fl">78</span>, <span class="fl">67</span>,
      <span class="fl">70</span>, <span class="fl">69</span>, <span class="fl">73</span>, <span class="fl">71</span>, <span class="fl">77</span>,
      <span class="fl">87</span>, <span class="fl">89</span>, <span class="fl">92</span>, <span class="fl">91</span>, <span class="fl">87</span>,
      <span class="fl">76</span>, <span class="fl">75</span>, <span class="fl">79</span>, <span class="fl">80</span>, <span class="fl">75</span>,
      <span class="fl">86</span>, <span class="fl">75</span>, <span class="fl">80</span>, <span class="fl">80</span>, <span class="fl">82</span>,
      <span class="fl">84</span>, <span class="fl">79</span>, <span class="fl">79</span>, <span class="fl">77</span>, <span class="fl">82</span>,
      <span class="fl">96</span>, <span class="fl">85</span>, <span class="fl">91</span>, <span class="fl">87</span>, <span class="fl">90</span><span class="op">)</span>,
    ncol<span class="op">=</span><span class="fl">5</span>, nrow<span class="op">=</span><span class="fl">10</span>, byrow<span class="op">=</span><span class="cn">T</span><span class="op">)</span>,
  muT <span class="op">=</span> <span class="fl">80</span>,
  sigmaT <span class="op">=</span> <span class="fl">6</span>, <span class="co">#sqrt(36)</span>
  sigmaE <span class="op">=</span> <span class="fl">4</span> <span class="co"># sqrt(16)</span>
<span class="op">)</span>

<span class="co"># initial values</span>
<span class="va">start_values</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>T<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">80</span>,<span class="fl">80</span>,<span class="fl">80</span>,<span class="fl">80</span>,<span class="fl">80</span>,<span class="fl">80</span>,<span class="fl">80</span>,<span class="fl">80</span>,<span class="fl">80</span>,<span class="fl">80</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># Next, need to fit the model</span>
<span class="co">#   I have explicitly outlined some common parameters</span>
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">stan</span><span class="op">(</span>
  model_code <span class="op">=</span> <span class="va">model_ctt2</span>, <span class="co"># model code to be compiled</span>
  data <span class="op">=</span> <span class="va">mydata</span>,          <span class="co"># my data</span>
  init <span class="op">=</span> <span class="va">start_values</span>,    <span class="co"># starting values</span>
  chains <span class="op">=</span> <span class="fl">4</span>,             <span class="co"># number of Markov chains</span>
  warmup <span class="op">=</span> <span class="fl">1000</span>,          <span class="co"># number of warm up iterations per chain</span>
  iter <span class="op">=</span> <span class="fl">5000</span>,            <span class="co"># total number of iterations per chain</span>
  cores <span class="op">=</span> <span class="fl">4</span>,              <span class="co"># number of cores (could use one per chain)</span>
  refresh <span class="op">=</span> <span class="fl">0</span>             <span class="co"># no progress shown</span>
<span class="op">)</span>

<span class="co"># first get a basic breakdown of the posteriors</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></code></pre></div>
<pre><code>## Inference for Stan model: anon_model.
## 4 chains, each with iter=5000; warmup=1000; thin=1; 
## post-warmup draws per chain=4000, total post-warmup draws=16000.
## 
##         mean se_mean   sd   2.5%    25%    50%    75%  97.5% n_eff Rhat
## T[1]   76.88    0.01 1.72  73.47  75.72  76.90  78.03  80.21 31735    1
## T[2]   79.08    0.01 1.73  75.69  77.93  79.06  80.22  82.47 29246    1
## T[3]   82.01    0.01 1.72  78.65  80.84  82.01  83.20  85.40 29176    1
## T[4]   75.05    0.01 1.71  71.72  73.89  75.06  76.22  78.41 28913    1
## T[5]   72.66    0.01 1.71  69.29  71.52  72.65  73.82  76.04 29610    1
## T[6]   88.44    0.01 1.70  85.12  87.32  88.44  89.57  91.76 28373    1
## T[7]   77.24    0.01 1.70  73.91  76.08  77.24  78.38  80.57 30229    1
## T[8]   80.56    0.01 1.69  77.25  79.43  80.56  81.72  83.84 28684    1
## T[9]   80.19    0.01 1.70  76.86  79.04  80.19  81.33  83.53 26627    1
## T[10]  89.00    0.01 1.74  85.60  87.83  88.99  90.18  92.39 29996    1
## lp__  -23.47    0.03 2.22 -28.78 -24.72 -23.16 -21.87 -20.10  7486    1
## 
## Samples were drawn using NUTS(diag_e) at Sun Jun 19 17:33:57 2022.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
<div class="sourceCode" id="cb103"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># plot the posterior in a</span>
<span class="co">#  95% probability interval</span>
<span class="co">#  and 80% to contrast the dispersion</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></code></pre></div>
<pre><code>## ci_level: 0.8 (80% intervals)</code></pre>
<pre><code>## outer_level: 0.95 (95% intervals)</code></pre>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-stan-2-1.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb106"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># traceplots</span>
<span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-traceplot.html">traceplot</a></span><span class="op">(</span><span class="va">fit</span>, pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"T"</span><span class="op">)</span>, inc_warmup <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-stan-2-2.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb107"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Gelman-Rubin-Brooks Convergence Criterion</span>
<span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">ggs_grb</span><span class="op">(</span><span class="fu">ggs</span><span class="op">(</span><span class="va">fit</span>, family <span class="op">=</span> <span class="st">"T"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
   <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">p1</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-stan-2-3.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb108"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># autocorrelation</span>
<span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">ggs_autocorrelation</span><span class="op">(</span><span class="fu">ggs</span><span class="op">(</span><span class="va">fit</span>, family<span class="op">=</span><span class="st">"T"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
   <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">p1</span> </code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-stan-2-4.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb109"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># plot the posterior density</span>
<span class="va">plot.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>

<span class="va">plot_title</span> <span class="op">&lt;-</span> <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Posterior distributions"</span>,
                      <span class="st">"with medians and 80% intervals"</span><span class="op">)</span>
<span class="fu">mcmc_areas</span><span class="op">(</span>
  <span class="va">plot.data</span>,
  pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"T["</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,<span class="st">"]"</span><span class="op">)</span>,
  prob <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span> 
  <span class="va">plot_title</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-stan-2-5.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb110"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># I prefer a posterior plot that includes prior and MLE</span>
<span class="co"># Expanded Posterior Plot</span>
<span class="va">MLE</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowMeans</a></span><span class="op">(</span><span class="va">mydata</span><span class="op">$</span><span class="va">X</span><span class="op">)</span>
<span class="va">prior_t</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">80</span>, <span class="fl">6</span><span class="op">)</span><span class="op">}</span>
<span class="va">x.t</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">50.1</span>, <span class="fl">100</span>, <span class="fl">0.1</span><span class="op">)</span>
<span class="va">prior.t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>tr<span class="op">=</span><span class="va">x.t</span>, dens.t <span class="op">=</span> <span class="fu">prior_t</span><span class="op">(</span><span class="va">x.t</span><span class="op">)</span><span class="op">)</span>
<span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Posterior"</span><span class="op">=</span><span class="st">"#0072B2"</span>, <span class="st">"Prior"</span><span class="op">=</span><span class="st">"#E69F00"</span>, <span class="st">"MLE"</span><span class="op">=</span> <span class="st">"black"</span><span class="op">)</span><span class="co">#"#56B4E9", "#E69F00" "#CC79A7"</span>
<span class="va">plot.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">plot.data</span><span class="op">)</span>
<span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">plot.data</span>,
               <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">`T[1]`</span>, color<span class="op">=</span><span class="st">"Posterior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span>data<span class="op">=</span><span class="va">prior.t</span>,
            <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">tr</span>, y<span class="op">=</span><span class="va">dens.t</span>, color<span class="op">=</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept<span class="op">=</span><span class="va">MLE</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, color<span class="op">=</span><span class="st">"MLE"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">cols</span>, name<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">plot.data</span>,
               <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">`T[2]`</span>, color<span class="op">=</span><span class="st">"Posterior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span>data<span class="op">=</span><span class="va">prior.t</span>,
            <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">tr</span>, y<span class="op">=</span><span class="va">dens.t</span>, color<span class="op">=</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept<span class="op">=</span><span class="va">MLE</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, color<span class="op">=</span><span class="st">"MLE"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">cols</span>, name<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">plot.data</span>,
               <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">`T[5]`</span>, color<span class="op">=</span><span class="st">"Posterior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span>data<span class="op">=</span><span class="va">prior.t</span>,
            <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">tr</span>, y<span class="op">=</span><span class="va">dens.t</span>, color<span class="op">=</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept<span class="op">=</span><span class="va">MLE</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span>, color<span class="op">=</span><span class="st">"MLE"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">cols</span>, name<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">p4</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">plot.data</span>,
               <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">`T[10]`</span>, color<span class="op">=</span><span class="st">"Posterior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span>data<span class="op">=</span><span class="va">prior.t</span>,
            <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">tr</span>, y<span class="op">=</span><span class="va">dens.t</span>, color<span class="op">=</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept<span class="op">=</span><span class="va">MLE</span><span class="op">[</span><span class="fl">10</span><span class="op">]</span>, color<span class="op">=</span><span class="st">"MLE"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">cols</span>, name<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>


<span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span> <span class="op">+</span> <span class="va">p3</span> <span class="op">+</span> <span class="va">p4</span> <span class="op">+</span> <span class="fu">plot_layout</span><span class="op">(</span>guides<span class="op">=</span><span class="st">"collect"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-stan-2-6.png" width="90%" height="90%"></div>
</div>
<div id="example-2---jags" class="section level2" number="8.6">
<h2>
<span class="header-section-number">8.6</span> Example 2 - JAGS<a class="anchor" aria-label="anchor" href="#example-2---jags"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb111"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># model code</span>
<span class="va">jags.model.ctt2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span>
   <span class="co">############################################</span>
     <span class="co"># CLASSICAL TEST THEORY</span>
     <span class="co"># WITH KNOWN </span>
     <span class="co">#    TRUE SCORE MEAN, TRUE SCORE VARIANCE</span>
     <span class="co">#    ERROR VARIANCE</span>
     <span class="co">############################################</span>

     <span class="co">############################################</span>
     <span class="co"># KNOWN HYPERPARAMETERS</span>
     <span class="co">############################################</span>
     <span class="va">mu.T</span> <span class="op">&lt;-</span> <span class="fl">80</span>               <span class="co"># Mean of the true scores</span>
     <span class="va">sigma.squared.T</span> <span class="op">&lt;-</span> <span class="fl">36</span>    <span class="co"># Variance of the true scores</span>
     <span class="va">sigma.squared.E</span> <span class="op">&lt;-</span> <span class="fl">16</span>    <span class="co"># Variance of the errors</span>

     <span class="va">tau.T</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="va">sigma.squared.T</span>   <span class="co"># Precision of the true scores</span>
     <span class="va">tau.E</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="va">sigma.squared.E</span>   <span class="co"># Precision of the errors</span>

 
     <span class="co">############################################</span>
     <span class="co"># MODEL FOR TRUE SCORES AND OBSERVABLES</span>
     <span class="co">############################################</span>
 
     <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span> <span class="op">{</span>
        <span class="cn">T</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">mu.T</span>, <span class="va">tau.T</span><span class="op">)</span>     <span class="co"># Distribution of true scores</span>
        <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">J</span><span class="op">)</span><span class="op">{</span>
          <span class="va">x</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="cn">T</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">tau.E</span><span class="op">)</span>     <span class="co"># Distribution of observables </span>
        <span class="op">}</span>
     <span class="op">}</span>
    
<span class="op">}</span>
<span class="co"># data</span>
<span class="va">mydata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  N <span class="op">=</span> <span class="fl">10</span>, J <span class="op">=</span> <span class="fl">5</span>, 
  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">80</span>, <span class="fl">77</span>, <span class="fl">80</span>, <span class="fl">73</span>, <span class="fl">73</span>,
      <span class="fl">83</span>, <span class="fl">79</span>, <span class="fl">78</span>, <span class="fl">78</span>, <span class="fl">77</span>,
      <span class="fl">85</span>, <span class="fl">77</span>, <span class="fl">88</span>, <span class="fl">81</span>, <span class="fl">80</span>,
      <span class="fl">76</span>, <span class="fl">76</span>, <span class="fl">76</span>, <span class="fl">78</span>, <span class="fl">67</span>,
      <span class="fl">70</span>, <span class="fl">69</span>, <span class="fl">73</span>, <span class="fl">71</span>, <span class="fl">77</span>,
      <span class="fl">87</span>, <span class="fl">89</span>, <span class="fl">92</span>, <span class="fl">91</span>, <span class="fl">87</span>,
      <span class="fl">76</span>, <span class="fl">75</span>, <span class="fl">79</span>, <span class="fl">80</span>, <span class="fl">75</span>,
      <span class="fl">86</span>, <span class="fl">75</span>, <span class="fl">80</span>, <span class="fl">80</span>, <span class="fl">82</span>,
      <span class="fl">84</span>, <span class="fl">79</span>, <span class="fl">79</span>, <span class="fl">77</span>, <span class="fl">82</span>,
      <span class="fl">96</span>, <span class="fl">85</span>, <span class="fl">91</span>, <span class="fl">87</span>, <span class="fl">90</span><span class="op">)</span>,
    ncol<span class="op">=</span><span class="fl">5</span>, nrow<span class="op">=</span><span class="fl">10</span>, byrow<span class="op">=</span><span class="cn">T</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># starting values</span>
<span class="va">start_values</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"T"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">80</span>,<span class="fl">10</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># vector of all parameters to save</span>
<span class="va">param_save</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"T"</span><span class="op">)</span>

<span class="co"># fit model</span>
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">jags</span><span class="op">(</span>
  model.file<span class="op">=</span><span class="va">jags.model.ctt2</span>,
  data<span class="op">=</span><span class="va">mydata</span>,
  inits<span class="op">=</span><span class="va">start_values</span>,
  parameters.to.save <span class="op">=</span> <span class="va">param_save</span>,
  n.iter<span class="op">=</span><span class="fl">4000</span>,
  n.burnin <span class="op">=</span> <span class="fl">1000</span>,
  n.chains <span class="op">=</span> <span class="fl">4</span>,
  n.thin<span class="op">=</span><span class="fl">1</span>,
  progress.bar <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></code></pre></div>
<pre><code>## Compiling model graph
##    Resolving undeclared variables
##    Allocating nodes
## Graph information:
##    Observed stochastic nodes: 50
##    Unobserved stochastic nodes: 10
##    Total graph size: 68
## 
## Initializing model</code></pre>
<div class="sourceCode" id="cb113"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></code></pre></div>
<pre><code>## Inference for Bugs model at "C:/Users/noahp/AppData/Local/Temp/RtmpQR8sbs/model4544135343d3.txt", fit using jags,
##  4 chains, each with 4000 iterations (first 1000 discarded)
##  n.sims = 12000 iterations saved
##          mu.vect sd.vect    2.5%     25%     50%     75%   97.5%  Rhat n.eff
## T[1]      76.858   1.693  73.521  75.712  76.845  77.982  80.164 1.001  4200
## T[2]      79.090   1.729  75.747  77.933  79.089  80.257  82.522 1.001 12000
## T[3]      82.028   1.700  78.704  80.860  82.031  83.173  85.338 1.001 12000
## T[4]      75.056   1.725  71.642  73.891  75.053  76.205  78.492 1.001  9800
## T[5]      72.654   1.695  69.363  71.489  72.633  73.808  75.984 1.001 12000
## T[6]      88.455   1.710  85.055  87.304  88.445  89.603  91.821 1.002  3100
## T[7]      77.261   1.702  73.905  76.145  77.252  78.399  80.587 1.001 12000
## T[8]      80.560   1.720  77.240  79.401  80.547  81.720  83.941 1.001 12000
## T[9]      80.211   1.707  76.886  79.050  80.219  81.373  83.565 1.001  3900
## T[10]     88.983   1.707  85.609  87.848  88.993  90.136  92.290 1.001 12000
## deviance 269.583   4.346 263.043 266.415 268.950 271.992 279.779 1.001  6800
## 
## For each parameter, n.eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor (at convergence, Rhat=1).
## 
## DIC info (using the rule, pD = var(deviance)/2)
## pD = 9.4 and DIC = 279.0
## DIC is an estimate of expected predictive error (lower deviance is better).</code></pre>
<div class="sourceCode" id="cb115"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># extract posteriors for all chains</span>
<span class="va">jags.mcmc</span> <span class="op">&lt;-</span> <span class="fu">as.mcmc</span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>

<span class="fu">R2jags</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/R2jags/man/traceplot.html">traceplot</a></span><span class="op">(</span><span class="va">jags.mcmc</span><span class="op">)</span></code></pre></div>
<p><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-jags-2-1.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-jags-2-2.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-jags-2-3.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-jags-2-4.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-jags-2-5.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-jags-2-6.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-jags-2-7.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-jags-2-8.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-jags-2-9.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-jags-2-10.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-jags-2-11.png" width="90%" height="90%"></p>
<div class="sourceCode" id="cb116"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># gelman-rubin-brook</span>
<span class="fu">gelman.plot</span><span class="op">(</span><span class="va">jags.mcmc</span><span class="op">)</span></code></pre></div>
<p><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-jags-2-12.png" width="90%" height="90%"><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-jags-2-13.png" width="90%" height="90%"></p>
<div class="sourceCode" id="cb117"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># convert to single data.frame for density plot</span>
<span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">jags.mcmc</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
<span class="va">plot.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">jags.mcmc</span>, chains<span class="op">=</span><span class="cn">T</span>, iters <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">plot.data</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"chain"</span>, <span class="st">"iter"</span>, <span class="va">a</span><span class="op">)</span>


<span class="va">plot_title</span> <span class="op">&lt;-</span> <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Posterior distributions"</span>,
                      <span class="st">"with medians and 80% intervals"</span><span class="op">)</span>
<span class="fu">mcmc_areas</span><span class="op">(</span>
  <span class="va">plot.data</span>,
  pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"T[1]"</span>, <span class="st">"T[2]"</span>, <span class="st">"T[3]"</span><span class="op">)</span>,
  prob <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span> 
  <span class="va">plot_title</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-jags-2-14.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb118"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># I prefer a posterior plot that includes prior and MLE</span>
<span class="va">MLE</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowMeans</a></span><span class="op">(</span><span class="va">mydata</span><span class="op">$</span><span class="va">X</span><span class="op">)</span></code></pre></div>
<pre><code>## Error in rowMeans(mydata$X): 'x' must be an array of at least two dimensions</code></pre>
<div class="sourceCode" id="cb120"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">prior_t</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">80</span>, <span class="fl">6</span><span class="op">)</span><span class="op">}</span>
<span class="va">x.t</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">50.1</span>, <span class="fl">100</span>, <span class="fl">0.1</span><span class="op">)</span>
<span class="va">prior.t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>tr<span class="op">=</span><span class="va">x.t</span>, dens.t <span class="op">=</span> <span class="fu">prior_t</span><span class="op">(</span><span class="va">x.t</span><span class="op">)</span><span class="op">)</span>
<span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Posterior"</span><span class="op">=</span><span class="st">"#0072B2"</span>, <span class="st">"Prior"</span><span class="op">=</span><span class="st">"#E69F00"</span>, <span class="st">"MLE"</span><span class="op">=</span> <span class="st">"black"</span><span class="op">)</span><span class="co">#"#56B4E9", "#E69F00" "#CC79A7"</span>

<span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">plot.data</span>,
               <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">`T[1]`</span>, color<span class="op">=</span><span class="st">"Posterior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span>data<span class="op">=</span><span class="va">prior.t</span>,
            <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">tr</span>, y<span class="op">=</span><span class="va">dens.t</span>, color<span class="op">=</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept<span class="op">=</span><span class="va">MLE</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, color<span class="op">=</span><span class="st">"MLE"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">cols</span>, name<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">plot.data</span>,
               <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">`T[2]`</span>, color<span class="op">=</span><span class="st">"Posterior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span>data<span class="op">=</span><span class="va">prior.t</span>,
            <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">tr</span>, y<span class="op">=</span><span class="va">dens.t</span>, color<span class="op">=</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept<span class="op">=</span><span class="va">MLE</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, color<span class="op">=</span><span class="st">"MLE"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">cols</span>, name<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">plot.data</span>,
               <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">`T[5]`</span>, color<span class="op">=</span><span class="st">"Posterior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span>data<span class="op">=</span><span class="va">prior.t</span>,
            <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">tr</span>, y<span class="op">=</span><span class="va">dens.t</span>, color<span class="op">=</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept<span class="op">=</span><span class="va">MLE</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span>, color<span class="op">=</span><span class="st">"MLE"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">cols</span>, name<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">plot.data</span>,
               <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">`T[10]`</span>, color<span class="op">=</span><span class="st">"Posterior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span>data<span class="op">=</span><span class="va">prior.t</span>,
            <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">tr</span>, y<span class="op">=</span><span class="va">dens.t</span>, color<span class="op">=</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept<span class="op">=</span><span class="va">MLE</span><span class="op">[</span><span class="fl">10</span><span class="op">]</span>, color<span class="op">=</span><span class="st">"MLE"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">cols</span>, name<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span> <span class="op">+</span> <span class="va">p3</span> <span class="op">+</span> <span class="fu">plot_layout</span><span class="op">(</span>guides<span class="op">=</span><span class="st">"collect"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-jags-2-15.png" width="90%" height="90%"></div>
</div>
<div id="example-3---unknown-measurement-model-with-multiple-measures" class="section level2" number="8.7">
<h2>
<span class="header-section-number">8.7</span> Example 3 - Unknown Measurement Model with Multiple Measures<a class="anchor" aria-label="anchor" href="#example-3---unknown-measurement-model-with-multiple-measures"><i class="fas fa-link"></i></a>
</h2>
<p>Here, we finally get to the (more) realistic case when we don’t have as much prior knowledge about the measurement model parameters (namely, variances).
The structure relies on hierarchically specifying priors to induce conditional independence.
The DAG and model-specification change to:</p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:chp8-dag-3"></span>
<img src="dag/chp8-ctt3.png" alt="Simple CTT model with unknown measurement parameters" width="90%" height="90%"><p class="caption">
Figure 8.5: Simple CTT model with unknown measurement parameters
</p>
</div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:chp8-spec-3"></span>
<img src="model-spec/chp8-ctt3.png" alt="Model specification diagram for the unknown measurement model parameters" width="90%" height="90%"><p class="caption">
Figure 8.6: Model specification diagram for the unknown measurement model parameters
</p>
</div>
</div>
<div id="example-3---stan" class="section level2" number="8.8">
<h2>
<span class="header-section-number">8.8</span> Example 3 - Stan<a class="anchor" aria-label="anchor" href="#example-3---stan"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb121"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model_ctt3</span> <span class="op">&lt;-</span> <span class="st">'
data {
  int  N;
  int  J;
  matrix[N, J] X;
}

parameters {
  real T[N];
  real muT;
  real&lt;lower=0&gt; sigmaT;
  real&lt;lower=0&gt; sigmaE;
}

model {
  for(i in 1:N){
    T[i] ~ normal(muT, sigmaT);
    for(j in 1:J){
      X[i, j] ~ normal(T[i], sigmaE);
    }
  }
  muT ~ normal(80, 10);
  sigmaT ~ inv_gamma(1, 6);
  sigmaE ~ inv_gamma(1, 4);
}

generated quantities {
  real rho;
  real rhocomp;

  rho = square(sigmaT)/(square(sigmaT) + square(sigmaE));
  rhocomp = J*rho/((J-1)*rho + 1);
}

'</span>
<span class="co"># data must be in a list</span>
<span class="va">mydata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  N <span class="op">=</span> <span class="fl">10</span>, J <span class="op">=</span> <span class="fl">5</span>,
  X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">80</span>, <span class="fl">77</span>, <span class="fl">80</span>, <span class="fl">73</span>, <span class="fl">73</span>,
      <span class="fl">83</span>, <span class="fl">79</span>, <span class="fl">78</span>, <span class="fl">78</span>, <span class="fl">77</span>,
      <span class="fl">85</span>, <span class="fl">77</span>, <span class="fl">88</span>, <span class="fl">81</span>, <span class="fl">80</span>,
      <span class="fl">76</span>, <span class="fl">76</span>, <span class="fl">76</span>, <span class="fl">78</span>, <span class="fl">67</span>,
      <span class="fl">70</span>, <span class="fl">69</span>, <span class="fl">73</span>, <span class="fl">71</span>, <span class="fl">77</span>,
      <span class="fl">87</span>, <span class="fl">89</span>, <span class="fl">92</span>, <span class="fl">91</span>, <span class="fl">87</span>,
      <span class="fl">76</span>, <span class="fl">75</span>, <span class="fl">79</span>, <span class="fl">80</span>, <span class="fl">75</span>,
      <span class="fl">86</span>, <span class="fl">75</span>, <span class="fl">80</span>, <span class="fl">80</span>, <span class="fl">82</span>,
      <span class="fl">84</span>, <span class="fl">79</span>, <span class="fl">79</span>, <span class="fl">77</span>, <span class="fl">82</span>,
      <span class="fl">96</span>, <span class="fl">85</span>, <span class="fl">91</span>, <span class="fl">87</span>, <span class="fl">90</span><span class="op">)</span>,
    ncol<span class="op">=</span><span class="fl">5</span>, nrow<span class="op">=</span><span class="fl">10</span>, byrow<span class="op">=</span><span class="cn">T</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># initial values</span>
<span class="va">start_values</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>T<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">80</span>,<span class="fl">80</span>,<span class="fl">80</span>,<span class="fl">80</span>,<span class="fl">80</span>,<span class="fl">80</span>,<span class="fl">80</span>,<span class="fl">80</span>,<span class="fl">80</span>,<span class="fl">80</span><span class="op">)</span>,
       muT<span class="op">=</span><span class="fl">80</span>, sigmaT<span class="op">=</span><span class="fl">10</span>, sigmaE<span class="op">=</span><span class="fl">5</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># Next, need to fit the model</span>
<span class="co">#   I have explicitly outlined some common parameters</span>
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">stan</span><span class="op">(</span>
  model_code <span class="op">=</span> <span class="va">model_ctt3</span>, <span class="co"># model code to be compiled</span>
  data <span class="op">=</span> <span class="va">mydata</span>,          <span class="co"># my data</span>
  init <span class="op">=</span> <span class="va">start_values</span>,    <span class="co"># starting values</span>
  chains <span class="op">=</span> <span class="fl">4</span>,             <span class="co"># number of Markov chains</span>
  warmup <span class="op">=</span> <span class="fl">1000</span>,          <span class="co"># number of warm up iterations per chain</span>
  iter <span class="op">=</span> <span class="fl">5000</span>,            <span class="co"># total number of iterations per chain</span>
  cores <span class="op">=</span> <span class="fl">4</span>,              <span class="co"># number of cores (could use one per chain)</span>
  refresh <span class="op">=</span> <span class="fl">0</span>             <span class="co"># no progress shown</span>
<span class="op">)</span>

<span class="co"># first get a basic breakdown of the posteriors</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></code></pre></div>
<pre><code>## Inference for Stan model: anon_model.
## 4 chains, each with iter=5000; warmup=1000; thin=1; 
## post-warmup draws per chain=4000, total post-warmup draws=16000.
## 
##            mean se_mean   sd    2.5%     25%     50%     75%   97.5% n_eff Rhat
## T[1]      76.86    0.01 1.52   73.90   75.86   76.86   77.86   79.92 24760    1
## T[2]      79.08    0.01 1.52   76.10   78.07   79.08   80.08   82.08 25643    1
## T[3]      82.03    0.01 1.52   79.02   81.01   82.03   83.05   84.97 24831    1
## T[4]      75.02    0.01 1.56   71.98   73.97   75.01   76.08   78.14 23847    1
## T[5]      72.62    0.01 1.56   69.57   71.59   72.60   73.66   75.74 21993    1
## T[6]      88.50    0.01 1.58   85.34   87.48   88.51   89.54   91.57 21711    1
## T[7]      77.23    0.01 1.53   74.22   76.22   77.23   78.26   80.24 22774    1
## T[8]      80.56    0.01 1.52   77.56   79.54   80.55   81.57   83.55 28472    1
## T[9]      80.19    0.01 1.52   77.19   79.19   80.20   81.20   83.17 24704    1
## T[10]     89.05    0.01 1.55   85.88   88.04   89.08   90.09   92.05 21249    1
## muT       80.12    0.01 1.94   76.32   78.88   80.11   81.37   83.91 17196    1
## sigmaT     6.00    0.01 1.63    3.64    4.87    5.72    6.81   10.00 14787    1
## sigmaE     3.50    0.00 0.40    2.82    3.22    3.47    3.75    4.39 15100    1
## rho        0.72    0.00 0.11    0.49    0.65    0.73    0.80    0.90 16035    1
## rhocomp    0.92    0.00 0.04    0.83    0.90    0.93    0.95    0.98 15119    1
## lp__    -115.09    0.04 2.82 -121.51 -116.80 -114.72 -113.03 -110.63  5833    1
## 
## Samples were drawn using NUTS(diag_e) at Sun Jun 19 17:35:30 2022.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
<div class="sourceCode" id="cb123"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># plot the posterior in a</span>
<span class="co">#  95% probability interval</span>
<span class="co">#  and 80% to contrast the dispersion</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></code></pre></div>
<pre><code>## 'pars' not specified. Showing first 10 parameters by default.</code></pre>
<pre><code>## ci_level: 0.8 (80% intervals)</code></pre>
<pre><code>## outer_level: 0.95 (95% intervals)</code></pre>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-stan-3-1.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb127"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># traceplots</span>
<span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-traceplot.html">traceplot</a></span><span class="op">(</span><span class="va">fit</span>, pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"T"</span>, <span class="st">"muT"</span>, <span class="st">"sigmaT"</span>, <span class="st">"sigmaE"</span>, <span class="st">"rho"</span>, <span class="st">"rhocomp"</span><span class="op">)</span>, inc_warmup <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-stan-3-2.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb128"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Gelman-Rubin-Brooks Convergence Criterion</span>
<span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">ggs_grb</span><span class="op">(</span><span class="fu">ggs</span><span class="op">(</span><span class="va">fit</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
   <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">p1</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-stan-3-3.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb129"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># autocorrelation</span>
<span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">ggs_autocorrelation</span><span class="op">(</span><span class="fu">ggs</span><span class="op">(</span><span class="va">fit</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
   <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">p1</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-stan-3-4.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb130"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># plot the posterior density</span>
<span class="va">plot.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>

<span class="va">plot_title</span> <span class="op">&lt;-</span> <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Posterior distributions"</span>,
                      <span class="st">"with medians and 80% intervals"</span><span class="op">)</span>
<span class="fu">mcmc_areas</span><span class="op">(</span>
  <span class="va">plot.data</span>,
  pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"T["</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,<span class="st">"]"</span><span class="op">)</span>, <span class="st">"muT"</span><span class="op">)</span>,
  prob <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span>
  <span class="va">plot_title</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-stan-3-5.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb131"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">mcmc_areas</span><span class="op">(</span>
  <span class="va">plot.data</span>,
  pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sigmaT"</span>, <span class="st">"sigmaE"</span><span class="op">)</span>,
  prob <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span>
  <span class="va">plot_title</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-stan-3-6.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb132"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">mcmc_areas</span><span class="op">(</span>
  <span class="va">plot.data</span>,
  pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"rho"</span>, <span class="st">"rhocomp"</span><span class="op">)</span>,
  prob <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span>
  <span class="va">plot_title</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-stan-3-7.png" width="90%" height="90%"></div>
<div class="sourceCode" id="cb133"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># I prefer a posterior plot that includes prior and MLE</span>
<span class="co"># Expanded Posterior Plot</span>
<span class="va">MLE</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowMeans</a></span><span class="op">(</span><span class="va">mydata</span><span class="op">$</span><span class="va">X</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">mydata</span><span class="op">$</span><span class="va">X</span><span class="op">)</span><span class="op">)</span>

<span class="va">prior_mu</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">80</span>, <span class="fl">10</span><span class="op">)</span><span class="op">}</span>
<span class="va">x.mu</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">50.1</span>, <span class="fl">100</span>, <span class="fl">0.1</span><span class="op">)</span>
<span class="va">prior.mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>mu<span class="op">=</span><span class="va">x.mu</span>, dens.mu <span class="op">=</span> <span class="fu">prior_mu</span><span class="op">(</span><span class="va">x.mu</span><span class="op">)</span><span class="op">)</span>

<span class="va">prior_sigt</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="fu">dinvgamma</span><span class="op">(</span><span class="va">x</span>, <span class="fl">1</span>, <span class="fl">6</span><span class="op">)</span><span class="op">}</span>
<span class="va">x.sigt</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">.1</span>, <span class="fl">15</span>, <span class="fl">0.1</span><span class="op">)</span>
<span class="va">prior.sigt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>sigt<span class="op">=</span><span class="va">x.sigt</span>, dens.sigt <span class="op">=</span> <span class="fu">prior_sigt</span><span class="op">(</span><span class="va">x.sigt</span><span class="op">)</span><span class="op">)</span>

<span class="va">prior_sige</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="fu">dinvgamma</span><span class="op">(</span><span class="va">x</span>, <span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span><span class="op">}</span>
<span class="va">x.sige</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">.1</span>, <span class="fl">10</span>, <span class="fl">0.1</span><span class="op">)</span>
<span class="va">prior.sige</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>sige<span class="op">=</span><span class="va">x.sige</span>, dens.sige <span class="op">=</span> <span class="fu">prior_sige</span><span class="op">(</span><span class="va">x.sige</span><span class="op">)</span><span class="op">)</span>

<span class="va">prior_t</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span>
  <span class="va">mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">80</span>, <span class="fl">10</span><span class="op">)</span>
  <span class="va">sig</span> <span class="op">&lt;-</span> <span class="fu">rinvgamma</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">mu</span>, <span class="va">sig</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">x.t</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">50.1</span>, <span class="fl">100</span>, <span class="fl">0.1</span><span class="op">)</span>
<span class="va">prior.t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>tr<span class="op">=</span><span class="fu">prior_t</span><span class="op">(</span><span class="fl">10000</span><span class="op">)</span><span class="op">)</span>


<span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Posterior"</span><span class="op">=</span><span class="st">"#0072B2"</span>, <span class="st">"Prior"</span><span class="op">=</span><span class="st">"#E69F00"</span>, <span class="st">"MLE"</span><span class="op">=</span> <span class="st">"black"</span><span class="op">)</span><span class="co">#"#56B4E9", "#E69F00" "#CC79A7"</span>
<span class="va">plot.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">plot.data</span><span class="op">)</span>
<span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">plot.data</span>, <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">`T[1]`</span>, color<span class="op">=</span><span class="st">"Posterior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">prior.t</span>,<span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">tr</span>,color<span class="op">=</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept<span class="op">=</span><span class="va">MLE</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, color<span class="op">=</span><span class="st">"MLE"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">cols</span>, name<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">plot.data</span>, <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">`T[5]`</span>, color<span class="op">=</span><span class="st">"Posterior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">prior.t</span>,<span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">tr</span>,color<span class="op">=</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept<span class="op">=</span><span class="va">MLE</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span>, color<span class="op">=</span><span class="st">"MLE"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">cols</span>, name<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">plot.data</span>, <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">`T[10]`</span>, color<span class="op">=</span><span class="st">"Posterior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">prior.t</span>,<span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">tr</span>,color<span class="op">=</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept<span class="op">=</span><span class="va">MLE</span><span class="op">[</span><span class="fl">10</span><span class="op">]</span>, color<span class="op">=</span><span class="st">"MLE"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">cols</span>, name<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">p4</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">plot.data</span>, <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">`muT`</span>, color<span class="op">=</span><span class="st">"Posterior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span>data<span class="op">=</span><span class="va">prior.mu</span>,<span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">mu</span>,y<span class="op">=</span><span class="va">dens.mu</span>,color<span class="op">=</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept<span class="op">=</span><span class="va">MLE</span><span class="op">[</span><span class="fl">11</span><span class="op">]</span>, color<span class="op">=</span><span class="st">"MLE"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">cols</span>, name<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">p5</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">plot.data</span>, <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">`sigmaT`</span>, color<span class="op">=</span><span class="st">"Posterior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span>data<span class="op">=</span><span class="va">prior.sigt</span>,<span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">sigt</span>,y<span class="op">=</span><span class="va">dens.sigt</span>,color<span class="op">=</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">cols</span>, name<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">p6</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">plot.data</span>, <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">`sigmaE`</span>, color<span class="op">=</span><span class="st">"Posterior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span>data<span class="op">=</span><span class="va">prior.sige</span>,<span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">sige</span>,y<span class="op">=</span><span class="va">dens.sige</span>,color<span class="op">=</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">cols</span>, name<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span> <span class="op">+</span> <span class="va">p3</span> <span class="op">+</span> <span class="va">p4</span> <span class="op">+</span> <span class="va">p5</span> <span class="op">+</span> <span class="va">p6</span> <span class="op">+</span> <span class="fu">plot_layout</span><span class="op">(</span>ncol<span class="op">=</span><span class="fl">3</span>, guides<span class="op">=</span><span class="st">"collect"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-stan-3-8.png" width="90%" height="90%"></div>
</div>
<div id="example-3---jags" class="section level2" number="8.9">
<h2>
<span class="header-section-number">8.9</span> Example 3 - JAGS<a class="anchor" aria-label="anchor" href="#example-3---jags"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb134"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># model code</span>
<span class="va">jags.model.ctt3</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span>
     <span class="co">############################################</span>
     <span class="co"># CLASSICAL TEST THEORY MODEL</span>
     <span class="co"># WITH UnkNOWN HYPERPARAMETERS</span>
     <span class="co">#    TRUE SCORE MEAN, TRUE SCORE VARIANCE</span>
     <span class="co">#    ERROR VARIANCE</span>
     <span class="co">############################################</span>

     <span class="co">############################################</span>
     <span class="co"># PRIOR DISTRIBUTIONS FOR HYPERPARAMETERS</span>
     <span class="co">############################################</span>
     <span class="va">muT</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="fl">80</span>,<span class="fl">.01</span><span class="op">)</span>     <span class="co"># Mean of the true scores</span>

     <span class="va">tau.T</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html">dgamma</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">36</span><span class="op">)</span>   <span class="co"># Precision of the true scores</span>
     <span class="va">tau.E</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html">dgamma</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">16</span><span class="op">)</span>   <span class="co"># Precision of the errors</span>

     <span class="va">sigma.squared.T</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="va">tau.T</span>    <span class="co"># Variance of the true scores</span>
     <span class="va">sigma.squared.E</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="va">tau.E</span>    <span class="co"># Variance of the errors</span>
     <span class="co"># get SD for summarizing</span>
     <span class="va">sigmaT</span> <span class="op">&lt;-</span> <span class="fu">pow</span><span class="op">(</span><span class="va">sigma.squared.T</span>, <span class="fl">0.5</span><span class="op">)</span>
     <span class="va">sigmaE</span> <span class="op">&lt;-</span> <span class="fu">pow</span><span class="op">(</span><span class="va">sigma.squared.E</span>, <span class="fl">0.5</span><span class="op">)</span>
     <span class="co">############################################</span>
     <span class="co"># MODEL FOR TRUE SCORES AND OBSERVABLES</span>
     <span class="co">############################################</span>

     <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span> <span class="op">{</span>
          <span class="cn">T</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">muT</span>, <span class="va">tau.T</span><span class="op">)</span>     <span class="co"># Distribution of true scores</span>
          <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">J</span><span class="op">)</span><span class="op">{</span>
               <span class="va">X</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span><span class="op">]</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="cn">T</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">tau.E</span><span class="op">)</span>     <span class="co"># Distribution of observables</span>
          <span class="op">}</span>
     <span class="op">}</span>

     <span class="co">############################################</span>
     <span class="co"># RELIABILITY</span>
     <span class="co">############################################</span>
     <span class="va">rho</span> <span class="op">&lt;-</span> <span class="va">sigma.squared.T</span><span class="op">/</span><span class="op">(</span><span class="va">sigma.squared.T</span><span class="op">+</span><span class="va">sigma.squared.E</span><span class="op">)</span>
     <span class="va">rhocomp</span> <span class="op">&lt;-</span> <span class="va">J</span><span class="op">*</span><span class="va">rho</span><span class="op">/</span><span class="op">(</span><span class="op">(</span><span class="va">J</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="va">rho</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span>

<span class="op">}</span>
<span class="co"># data</span>
<span class="va">mydata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  N <span class="op">=</span> <span class="fl">10</span>, J <span class="op">=</span> <span class="fl">5</span>,
  X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">80</span>, <span class="fl">77</span>, <span class="fl">80</span>, <span class="fl">73</span>, <span class="fl">73</span>,
      <span class="fl">83</span>, <span class="fl">79</span>, <span class="fl">78</span>, <span class="fl">78</span>, <span class="fl">77</span>,
      <span class="fl">85</span>, <span class="fl">77</span>, <span class="fl">88</span>, <span class="fl">81</span>, <span class="fl">80</span>,
      <span class="fl">76</span>, <span class="fl">76</span>, <span class="fl">76</span>, <span class="fl">78</span>, <span class="fl">67</span>,
      <span class="fl">70</span>, <span class="fl">69</span>, <span class="fl">73</span>, <span class="fl">71</span>, <span class="fl">77</span>,
      <span class="fl">87</span>, <span class="fl">89</span>, <span class="fl">92</span>, <span class="fl">91</span>, <span class="fl">87</span>,
      <span class="fl">76</span>, <span class="fl">75</span>, <span class="fl">79</span>, <span class="fl">80</span>, <span class="fl">75</span>,
      <span class="fl">86</span>, <span class="fl">75</span>, <span class="fl">80</span>, <span class="fl">80</span>, <span class="fl">82</span>,
      <span class="fl">84</span>, <span class="fl">79</span>, <span class="fl">79</span>, <span class="fl">77</span>, <span class="fl">82</span>,
      <span class="fl">96</span>, <span class="fl">85</span>, <span class="fl">91</span>, <span class="fl">87</span>, <span class="fl">90</span><span class="op">)</span>,
    ncol<span class="op">=</span><span class="fl">5</span>, nrow<span class="op">=</span><span class="fl">10</span>, byrow<span class="op">=</span><span class="cn">T</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># initial values</span>
<span class="va">start_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"T"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">60</span>,<span class="fl">85</span>,<span class="fl">80</span>,<span class="fl">95</span>,<span class="fl">74</span>,<span class="fl">69</span>,<span class="fl">91</span>,<span class="fl">82</span>,<span class="fl">87</span>,<span class="fl">78</span><span class="op">)</span>,
       <span class="st">"muT"</span><span class="op">=</span><span class="fl">80</span>, <span class="st">"tau.E"</span><span class="op">=</span><span class="fl">0.06</span>, <span class="st">"tau.T"</span><span class="op">=</span><span class="fl">0.023</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"T"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">63</span>, <span class="fl">79</span>, <span class="fl">74</span>, <span class="fl">104</span>, <span class="fl">80</span>, <span class="fl">71</span>, <span class="fl">95</span>, <span class="fl">72</span>, <span class="fl">80</span>, <span class="fl">82</span><span class="op">)</span>,
       <span class="st">"muT"</span><span class="op">=</span><span class="fl">100</span>, <span class="st">"tau.E"</span><span class="op">=</span><span class="fl">0.09</span>, <span class="st">"tau.T"</span><span class="op">=</span><span class="fl">0.05</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"T"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">59</span>, <span class="fl">86</span>, <span class="fl">88</span>, <span class="fl">89</span>, <span class="fl">76</span>, <span class="fl">65</span>, <span class="fl">94</span>, <span class="fl">72</span>, <span class="fl">95</span>, <span class="fl">84</span><span class="op">)</span>,
       <span class="st">"muT"</span><span class="op">=</span><span class="fl">70</span>, <span class="st">"tau.E"</span><span class="op">=</span><span class="fl">0.03</span>, <span class="st">"tau.T"</span><span class="op">=</span><span class="fl">0.001</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"T"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">60</span>, <span class="fl">87</span>, <span class="fl">90</span>, <span class="fl">91</span>, <span class="fl">77</span>, <span class="fl">74</span>, <span class="fl">95</span>, <span class="fl">76</span>, <span class="fl">83</span>, <span class="fl">87</span><span class="op">)</span>,
       <span class="st">"muT"</span><span class="op">=</span><span class="fl">90</span>, <span class="st">"tau.E"</span><span class="op">=</span><span class="fl">0.01</span>, <span class="st">"tau.T"</span><span class="op">=</span><span class="fl">0.1</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># vector of all parameters to save</span>
<span class="va">param_save</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"T"</span>,<span class="st">"muT"</span>,<span class="st">"sigmaT"</span>,<span class="st">"sigmaE"</span>, <span class="st">"rho"</span>, <span class="st">"rhocomp"</span><span class="op">)</span>

<span class="co"># fit model</span>
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">jags</span><span class="op">(</span>
  model.file<span class="op">=</span><span class="va">jags.model.ctt2</span>,
  data<span class="op">=</span><span class="va">mydata</span>,
  inits<span class="op">=</span><span class="va">start_values</span>,
  parameters.to.save <span class="op">=</span> <span class="va">param_save</span>,
  n.iter<span class="op">=</span><span class="fl">4000</span>,
  n.burnin <span class="op">=</span> <span class="fl">1000</span>,
  n.chains <span class="op">=</span> <span class="fl">4</span>,
  n.thin<span class="op">=</span><span class="fl">1</span>,
  progress.bar <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></code></pre></div>
<pre><code>## Warning in jags.model(model.file, data = data, inits = init.values, n.chains = n.chains, : Unused
## variable "X" in data</code></pre>
<pre><code>## Compiling model graph
##    Resolving undeclared variables
##    Allocating nodes
## Graph information:
##    Observed stochastic nodes: 0
##    Unobserved stochastic nodes: 60
##    Total graph size: 68
## 
## Deleting model</code></pre>
<pre><code>## Error in setParameters(init.values[[i]], i): Error in node tau.E
## Cannot set value of non-variable node</code></pre>
<div class="sourceCode" id="cb138"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></code></pre></div>
<pre><code>## Inference for Stan model: anon_model.
## 4 chains, each with iter=5000; warmup=1000; thin=1; 
## post-warmup draws per chain=4000, total post-warmup draws=16000.
## 
##            mean se_mean   sd    2.5%     25%     50%     75%   97.5% n_eff Rhat
## T[1]      76.86    0.01 1.52   73.90   75.86   76.86   77.86   79.92 24760    1
## T[2]      79.08    0.01 1.52   76.10   78.07   79.08   80.08   82.08 25643    1
## T[3]      82.03    0.01 1.52   79.02   81.01   82.03   83.05   84.97 24831    1
## T[4]      75.02    0.01 1.56   71.98   73.97   75.01   76.08   78.14 23847    1
## T[5]      72.62    0.01 1.56   69.57   71.59   72.60   73.66   75.74 21993    1
## T[6]      88.50    0.01 1.58   85.34   87.48   88.51   89.54   91.57 21711    1
## T[7]      77.23    0.01 1.53   74.22   76.22   77.23   78.26   80.24 22774    1
## T[8]      80.56    0.01 1.52   77.56   79.54   80.55   81.57   83.55 28472    1
## T[9]      80.19    0.01 1.52   77.19   79.19   80.20   81.20   83.17 24704    1
## T[10]     89.05    0.01 1.55   85.88   88.04   89.08   90.09   92.05 21249    1
## muT       80.12    0.01 1.94   76.32   78.88   80.11   81.37   83.91 17196    1
## sigmaT     6.00    0.01 1.63    3.64    4.87    5.72    6.81   10.00 14787    1
## sigmaE     3.50    0.00 0.40    2.82    3.22    3.47    3.75    4.39 15100    1
## rho        0.72    0.00 0.11    0.49    0.65    0.73    0.80    0.90 16035    1
## rhocomp    0.92    0.00 0.04    0.83    0.90    0.93    0.95    0.98 15119    1
## lp__    -115.09    0.04 2.82 -121.51 -116.80 -114.72 -113.03 -110.63  5833    1
## 
## Samples were drawn using NUTS(diag_e) at Sun Jun 19 17:35:30 2022.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
<div class="sourceCode" id="cb140"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># extract posteriors for all chains</span>
<span class="va">jags.mcmc</span> <span class="op">&lt;-</span> <span class="fu">as.mcmc</span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>

<span class="fu">R2jags</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/R2jags/man/traceplot.html">traceplot</a></span><span class="op">(</span><span class="va">jags.mcmc</span><span class="op">)</span></code></pre></div>
<pre><code>## Error in xy.coords(x, y, xlabel, ylabel, log = log, recycle = TRUE): 'list' object cannot be coerced to type 'double'</code></pre>
<div class="sourceCode" id="cb142"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># gelman-rubin-brook</span>
<span class="fu">gelman.plot</span><span class="op">(</span><span class="va">jags.mcmc</span><span class="op">)</span></code></pre></div>
<pre><code>## Error in gelman.preplot(x, bin.width = bin.width, max.bins = max.bins, : Insufficient iterations to produce Gelman-Rubin plot</code></pre>
<div class="sourceCode" id="cb144"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># convert to single data.frame for density plot</span>
<span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">jags.mcmc</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## Error in jags.mcmc[[1]]: this S4 class is not subsettable</code></pre>
<div class="sourceCode" id="cb146"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">plot.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">jags.mcmc</span>, chains<span class="op">=</span><span class="cn">T</span>, iters <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## Error in y[, var.cols] &lt;- x: number of items to replace is not a multiple of replacement length</code></pre>
<div class="sourceCode" id="cb148"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">plot.data</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"chain"</span>, <span class="st">"iter"</span>, <span class="va">a</span><span class="op">)</span>


<span class="va">plot_title</span> <span class="op">&lt;-</span> <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Posterior distributions"</span>,
                      <span class="st">"with medians and 80% intervals"</span><span class="op">)</span>
<span class="fu">mcmc_areas</span><span class="op">(</span>
  <span class="va">plot.data</span>,
  pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"T["</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,<span class="st">"]"</span><span class="op">)</span>, <span class="st">"muT"</span><span class="op">)</span>,
  prob <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span>
  <span class="va">plot_title</span></code></pre></div>
<pre><code>## Error in x[, j, ] &lt;- a[chain == j, , drop = FALSE]: replacement has length zero</code></pre>
<div class="sourceCode" id="cb150"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">mcmc_areas</span><span class="op">(</span>
  <span class="va">plot.data</span>,
  pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sigmaT"</span>, <span class="st">"sigmaE"</span><span class="op">)</span>,
  prob <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span>
  <span class="va">plot_title</span></code></pre></div>
<pre><code>## Error in x[, j, ] &lt;- a[chain == j, , drop = FALSE]: replacement has length zero</code></pre>
<div class="sourceCode" id="cb152"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">mcmc_areas</span><span class="op">(</span>
  <span class="va">plot.data</span>,
  pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"rho"</span>, <span class="st">"rhocomp"</span><span class="op">)</span>,
  prob <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span>
  <span class="va">plot_title</span></code></pre></div>
<pre><code>## Error in x[, j, ] &lt;- a[chain == j, , drop = FALSE]: replacement has length zero</code></pre>
<div class="sourceCode" id="cb154"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># I prefer a posterior plot that includes prior and MLE</span>
<span class="va">MLE</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowMeans</a></span><span class="op">(</span><span class="va">mydata</span><span class="op">$</span><span class="va">X</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">mydata</span><span class="op">$</span><span class="va">X</span><span class="op">)</span><span class="op">)</span>

<span class="va">prior_mu</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">80</span>, <span class="fl">10</span><span class="op">)</span><span class="op">}</span>
<span class="va">x.mu</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">50.1</span>, <span class="fl">100</span>, <span class="fl">0.1</span><span class="op">)</span>
<span class="va">prior.mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>mu<span class="op">=</span><span class="va">x.mu</span>, dens.mu <span class="op">=</span> <span class="fu">prior_mu</span><span class="op">(</span><span class="va">x.mu</span><span class="op">)</span><span class="op">)</span>

<span class="va">prior_sigt</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="fu">dinvgamma</span><span class="op">(</span><span class="va">x</span>, <span class="fl">1</span>, <span class="fl">6</span><span class="op">)</span><span class="op">}</span>
<span class="va">x.sigt</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">.1</span>, <span class="fl">15</span>, <span class="fl">0.1</span><span class="op">)</span>
<span class="va">prior.sigt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>sigt<span class="op">=</span><span class="va">x.sigt</span>, dens.sigt <span class="op">=</span> <span class="fu">prior_sigt</span><span class="op">(</span><span class="va">x.sigt</span><span class="op">)</span><span class="op">)</span>

<span class="va">prior_sige</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="fu">dinvgamma</span><span class="op">(</span><span class="va">x</span>, <span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span><span class="op">}</span>
<span class="va">x.sige</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">.1</span>, <span class="fl">10</span>, <span class="fl">0.1</span><span class="op">)</span>
<span class="va">prior.sige</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>sige<span class="op">=</span><span class="va">x.sige</span>, dens.sige <span class="op">=</span> <span class="fu">prior_sige</span><span class="op">(</span><span class="va">x.sige</span><span class="op">)</span><span class="op">)</span>

<span class="va">prior_t</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span>
  <span class="va">mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">80</span>, <span class="fl">10</span><span class="op">)</span>
  <span class="va">sig</span> <span class="op">&lt;-</span> <span class="fu">rinvgamma</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">mu</span>, <span class="va">sig</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">x.t</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">50.1</span>, <span class="fl">100</span>, <span class="fl">0.1</span><span class="op">)</span>
<span class="va">prior.t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>tr<span class="op">=</span><span class="fu">prior_t</span><span class="op">(</span><span class="fl">10000</span><span class="op">)</span><span class="op">)</span>
<span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Posterior"</span><span class="op">=</span><span class="st">"#0072B2"</span>, <span class="st">"Prior"</span><span class="op">=</span><span class="st">"#E69F00"</span>, <span class="st">"MLE"</span><span class="op">=</span> <span class="st">"black"</span><span class="op">)</span><span class="co">#"#56B4E9", "#E69F00" "#CC79A7"</span>

<span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">plot.data</span>, <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">`T[1]`</span>, color<span class="op">=</span><span class="st">"Posterior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">prior.t</span>,<span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">tr</span>,color<span class="op">=</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept<span class="op">=</span><span class="va">MLE</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, color<span class="op">=</span><span class="st">"MLE"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">cols</span>, name<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">plot.data</span>, <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">`T[5]`</span>, color<span class="op">=</span><span class="st">"Posterior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">prior.t</span>,<span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">tr</span>,color<span class="op">=</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept<span class="op">=</span><span class="va">MLE</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span>, color<span class="op">=</span><span class="st">"MLE"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">cols</span>, name<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">plot.data</span>, <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">`T[10]`</span>, color<span class="op">=</span><span class="st">"Posterior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">prior.t</span>,<span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">tr</span>,color<span class="op">=</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept<span class="op">=</span><span class="va">MLE</span><span class="op">[</span><span class="fl">10</span><span class="op">]</span>, color<span class="op">=</span><span class="st">"MLE"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">cols</span>, name<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">p4</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">plot.data</span>, <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">`muT`</span>, color<span class="op">=</span><span class="st">"Posterior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span>data<span class="op">=</span><span class="va">prior.mu</span>,<span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">mu</span>,y<span class="op">=</span><span class="va">dens.mu</span>,color<span class="op">=</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept<span class="op">=</span><span class="va">MLE</span><span class="op">[</span><span class="fl">11</span><span class="op">]</span>, color<span class="op">=</span><span class="st">"MLE"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">cols</span>, name<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">p5</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">plot.data</span>, <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">`sigmaT`</span>, color<span class="op">=</span><span class="st">"Posterior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span>data<span class="op">=</span><span class="va">prior.sigt</span>,<span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">sigt</span>,y<span class="op">=</span><span class="va">dens.sigt</span>,color<span class="op">=</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">cols</span>, name<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">p6</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_density</span><span class="op">(</span>data<span class="op">=</span><span class="va">plot.data</span>, <span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">`sigmaE`</span>, color<span class="op">=</span><span class="st">"Posterior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span>data<span class="op">=</span><span class="va">prior.sige</span>,<span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">sige</span>,y<span class="op">=</span><span class="va">dens.sige</span>,color<span class="op">=</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">cols</span>, name<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span> <span class="op">+</span> <span class="va">p3</span> <span class="op">+</span> <span class="va">p4</span> <span class="op">+</span> <span class="va">p5</span> <span class="op">+</span> <span class="va">p6</span> <span class="op">+</span> <span class="fu">plot_layout</span><span class="op">(</span>ncol<span class="op">=</span><span class="fl">3</span>, guides<span class="op">=</span><span class="st">"collect"</span><span class="op">)</span></code></pre></div>
<pre><code>## Error in FUN(X[[i]], ...): object 'muT' not found</code></pre>
<div class="inline-figure"><img src="bookdown-BPM_files/figure-html/chp8-ctt-fit-jags-3-1.png" width="90%" height="90%"></div>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="canonical-bayesian-psychometric-modeling.html"><span class="header-section-number">7</span> Canonical Bayesian Psychometric Modeling</a></div>
<div class="next"><a href="confirmatory-factor-analysis.html"><span class="header-section-number">9</span> Confirmatory Factor Analysis</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#classical-test-theory"><span class="header-section-number">8</span> Classical Test Theory</a></li>
<li><a class="nav-link" href="#example-1---known-measurement-model-parameters-with-1-measure"><span class="header-section-number">8.1</span> Example 1 - Known measurement model parameters with 1 measure</a></li>
<li><a class="nav-link" href="#example-1---stan"><span class="header-section-number">8.2</span> Example 1 - Stan</a></li>
<li><a class="nav-link" href="#example-1---jags"><span class="header-section-number">8.3</span> Example 1 - JAGS</a></li>
<li><a class="nav-link" href="#example-2---known-measurement-model-with-multiple-measures"><span class="header-section-number">8.4</span> Example 2 - Known Measurement Model with Multiple Measures</a></li>
<li><a class="nav-link" href="#example-2---stan"><span class="header-section-number">8.5</span> Example 2 - Stan</a></li>
<li><a class="nav-link" href="#example-2---jags"><span class="header-section-number">8.6</span> Example 2 - JAGS</a></li>
<li><a class="nav-link" href="#example-3---unknown-measurement-model-with-multiple-measures"><span class="header-section-number">8.7</span> Example 3 - Unknown Measurement Model with Multiple Measures</a></li>
<li><a class="nav-link" href="#example-3---stan"><span class="header-section-number">8.8</span> Example 3 - Stan</a></li>
<li><a class="nav-link" href="#example-3---jags"><span class="header-section-number">8.9</span> Example 3 - JAGS</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/noah-padgett/Bayesian-Psychometric-Modeling/blob/master/08-ctt.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/noah-padgett/Bayesian-Psychometric-Modeling/edit/master/08-ctt.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Bayesian Psychometric Modeling (2016) by Roy Levy and Robert J. Mislevy</strong>" was written by R. Noah Padgett. It was last built on 2022-06-19.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
